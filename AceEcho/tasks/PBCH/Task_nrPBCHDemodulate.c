
/**
 * ****************************************
 * @file        Task_nrPBCHDemodulate.c
 * @brief       PBCH Demodulate
 * @author      yuanfeng
 * @date        2024.5.11
 * @copyright   ACE-Lab(Shanghai University)
 * ****************************************
 */

#include "riscv_printf.h"
#include "venus.h"

typedef short __v2048i16 __attribute__((ext_vector_type(2048)));
typedef short __v4096i16 __attribute__((ext_vector_type(4096)));
typedef char  __v4096i8 __attribute__((ext_vector_type(4096)));

short rxSignalLength = 432;
short softBitlLength = 864;
// char input_inSignal_real[432] = {
//     83,  85,   102, 93,   100,  -64, -76,  -78,  100,  103, -82,  -90,  88,
//     -90, 81,   -96, -106, 88,   -99, -119, 90,   -75,  -84, -95,  -105, -105,
//     68,  -97,  59,  -106, -97,  67,  -100, -100, 71,   64,  -81,  65,   69,
//     61,  -101, -96, -89,  -107, 70,  70,   77,   -82,  92,  -84,  102,  97,
//     97,  -78,  -73, 91,   -73,  86,  96,   -87,  -86,  -84, 81,   94,   -96,
//     97,  -78,  77,  -65,  -68,  -63, 88,   88,   -60,  103, 93,   97,   -57,
//     98,  97,   97,  -90,  -96,  -93, 84,   -103, -112, 90,  -126, 80,   -151,
//     103, -123, -99, 96,   -89,  100, 88,   104,  99,   -78, 95,   101,  88,
//     -88, -90,  -83, 75,   -87,  84,  -77,  -59,  79,   112, 105,  106,  -72,
//     -73, -70,  86,  -70,  86,   87,  -84,  -75,  -70,  -75, 76,   90,   -89,
//     -86, -87,  101, 92,   90,   103, 114,  137,  117,  -52, 110,  101,  -71,
//     -67, 98,   93,  -70,  108,  86,  88,   -57,  109,  -63, 130,  105,  -69,
//     99,  99,   98,  105,  104,  -62, 83,   89,   -84,  -88, -72,  -77,  87,
//     97,  -59,  90,  93,   117,  102, 107,  94,   74,   105, 53,   91,   -94,
//     91,  95,   -90, -93,  87,   -94, -94,  -95,  -93,  -83, -93,  -97,  95,
//     93,  -100, 94,  93,   92,   99,  -90,  -97,  -95,  96,  -91,  90,   -91,
//     95,  -95,  -93, 93,   -94,  -97, 100,  -100, 90,   -89, 88,   93,   90,
//     97,  -92,  90,  95,   92,   -93, -92,  -94,  91,   -90, -98,  -95,  -94,
//     -97, 90,   89,  -91,  92,   94,  -85,  -96,  92,   96,  89,   86,   -90,
//     -91, 87,   -91, -87,  104,  89,  85,   -88,  -87,  -85, 92,   -86,  -87,
//     86,  -84,  86,  -88,  -88,  -88, -87,  -92,  -96,  -92, -82,  88,   -91,
//     87,  -88,  86,  85,   -94,  87,  -88,  -92,  90,   84,  -88,  -93,  -82,
//     -96, 80,   -80, 84,   83,   86,  90,   83,   88,   -89, -88,  -91,  86,
//     -85, 84,   -91, -88,  90,   85,  -85,  87,   85,   90,  -86,  -83,  90,
//     -93, 91,   90,  87,   -89,  87,  89,   87,   -83,  90,  -92,  90,   -93,
//     -92, -82,  82,  90,   -91,  -83, -85,  -88,  87,   -96, 89,   92,   -83,
//     -95, -90,  86,  -83,  -70,  -72, -86,  -91,  89,   83,  90,   -83,  95,
//     -92, 89,   81,  89,   86,   -84, 88,   -89,  -84,  86,  -86,  -84,  -96,
//     89,  -90,  -91, -86,  90,   90,  83,   -86,  -83,  83,  -84,  88,   -89,
//     -87, 83,   85,  -85,  -88,  -89, 91,   87,   -86,  91,  88,   -95,  -86,
//     -85, 94,   -93, -84,  -85,  86,  -93,  97,   -98,  93,  89,   -86,  93,
//     90,  -89,  -85, -87,  -86,  97,  95,   -96,  -83,  86,  87,   -91,  -90,
//     -86, -87,  88,  -92,  -88,  -91, 91,   -85,  76,   -85, 90,   86,   88,
//     -93, 96,   99};
// char input_inSignal_imag[432] = {
//     106,  104, -68,  83,   76,  86,   -87,  -90,  -91,  -92,  -104, 79, -91,
//     86,   85,  -84,  109,  120, 136,  -51,  90,   135,  150,  157,  142, 119,
//     112,  89,  103,  84,   -95, 108,  -104, 81,   -93,  -92,  65,   -97,  54,
//     -106, -97, 80,   82,   -99, -114, -98,  -94,  59,   -99,  -104, -113,
//     -110, -102, 73,  -96,  82,   -92, 92,   -89,  86,   86,   -82,  -82,  91,
//     -65, 100,  115, -76,  103,  -59, 94,   -59,  89,   82,   -65,  85,   -78,
//     80, 74,   -90, -101, -102, 85,  -98,  87,   96,   -79,  107,  -106, 131,
//     107, -71,  97,  89,   -73,  92,  -83,  92,   -82,  -89,  74,   78,   78,
//     -98, 94,   -90, -79,  107,  89,  103,  -58,  111,  -77,  92,   95,   90,
//     92, 74,   -87, -89,  62,   -99, -95,  50,   -107, -111, -103, 77,   -97,
//     -97, 89,   -91, 100,  95,   89,  -73,  96,   108,  -105, 97,   70,   65,
//     -73, -70,  68,  -86,  77,   -74, 92,   87,   -88,  -88,  111,  81, -100,
//     -81, -86,  79,  84,   -83,  -92, -98,  67,   64,   -96,  -82,  78,   -86,
//     78, -78,  -89, 86,   89,   -66, 84,   -81,  -88,  -99,  29,   -96,  92,
//     86, 91,   -91, -92,  -96,  86,  95,   -90,  94,   -94,  90,   91,   95,
//     90, 94,   -93, 85,   88,   90,  -93,  94,   -89,  -92,  86,   94,   -92,
//     98, 95,   -90, 101,  94,   101, -90,  92,   -96,  -96,  94,   86,   90,
//     -86, 88,   87,  93,   90,   94,  -93,  -90,  93,   89,   94,   95,   -91,
//     -87, -84,  -98, -94,  96,   -93, -91,  94,   -94,  -99,  85,   -92,  -88,
//     -92, -90,  91,  -96,  -102, -87, -84,  -84,  87,   -89,  -91,  -84,  -95,
//     -85, -87,  87,  -89,  82,   -92, 88,   84,   85,   -88,  -87,  90,   -91,
//     88, 83,   88,  -85,  87,   85,  87,   85,   94,   90,   85,   89,   89,
//     -95, 87,   93,  -95,  91,   90,  -89,  94,   89,   91,   -95,  91,   90,
//     87, -88,  91,  -90,  -91,  85,  -86,  -89,  -88,  -86,  -84,  82,   -84,
//     90, -95,  -90, 92,   89,   -88, 89,   85,   89,   -92,  87,   86,   -89,
//     88, -88,  86,  87,   -88,  89,  -90,  -90,  -97,  97,   86,   -86,  -84,
//     -90, 86,   -84, 69,   -64,  77,  83,   -87,  82,   -91,  93,   -83,  -92,
//     -87, 85,   -90, 91,   -91,  94,  -89,  87,   -89,  -92,  90,   -91,  87,
//     92, 87,   90,  -89,  92,   -92, -88,  -86,  88,   -85,  -88,  86,   86,
//     -83, -85,  87,  -82,  83,   -90, -90,  -90,  84,   -89,  84,   88,   88,
//     -91, -86,  -86, 89,   -90,  -90, 93,   88,   -92,  87,   -91,  88,   -93,
//     -85, -93,  88,  -85,  -96,  -95, -84,  -85,  88,   -92,  90,   85,   -90,
//     -87, -90,  84,  84,   87,   86,  -88,  82,   -81,  -91,  91,   85,   88,
//     -90, 78,   -82, -80};

char nVar = 20;

int Task_nrPBCHDemodulate(__v4096i8 inSignal_real, __v4096i8 inSignal_imag) {
  int fractionLength = 7;

  /*--------------------QPSK Demodulate--------------------*/
  __v4096i8  softbit;
  __v2048i16 softbit_shuffle_index_tmp;
  vclaim(softbit_shuffle_index_tmp);
  vclaim(softbit);
  vrange(softbit_shuffle_index_tmp, rxSignalLength);
  softbit_shuffle_index_tmp = vmul(softbit_shuffle_index_tmp, 2, MASKREAD_OFF, rxSignalLength);
  vshuffle(softbit, softbit_shuffle_index_tmp, inSignal_real, SHUFFLE_SCATTER, rxSignalLength);
  softbit_shuffle_index_tmp = vsadd(softbit_shuffle_index_tmp, 1, MASKREAD_OFF, rxSignalLength);
  vshuffle(softbit, softbit_shuffle_index_tmp, inSignal_imag, SHUFFLE_SCATTER, rxSignalLength);

  vreturn(softbit, softBitlLength);
}