/**
 * ****************************************
 * @file        Task_nrPBCHChannelEstimate.c
 * @brief       PBCH channel estimation using LS
 * @author      yuanfeng
 * @date        2024.6.5
 * @copyright   ACE-Lab(Shanghai University)
 * ****************************************
 */

#include "riscv_printf.h"
#include "venus.h"

typedef short __v2048i16 __attribute__((ext_vector_type(2048)));
typedef short __v4096i16 __attribute__((ext_vector_type(4096)));
typedef char  __v4096i8 __attribute__((ext_vector_type(4096)));

static int fractionLength = 7;

char W_real[60 * 8] = {
    127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,
    127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,
    127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,
    127,  127,  127,  127,  127,  125,  121,  116,  110,  103,  95,   85,   75,   64,   52,   39,   26,   13,   0,
    -14,  -27,  -40,  -53,  -64,  -76,  -86,  -96,  -104, -111, -117, -122, -126, -128, -128, -128, -126, -122, -117,
    -111, -104, -96,  -86,  -76,  -65,  -53,  -40,  -27,  -14,  -1,   13,   26,   39,   52,   64,   75,   85,   95,
    103,  110,  116,  121,  125,  127,  127,  125,  116,  103,  85,   64,   39,   13,   -14,  -40,  -64,  -86,  -104,
    -117, -126, -128, -126, -117, -104, -86,  -65,  -40,  -14,  13,   39,   64,   85,   103,  116,  125,  127,  125,
    116,  103,  85,   64,   39,   13,   -14,  -40,  -64,  -86,  -104, -117, -126, -128, -126, -117, -104, -86,  -64,
    -40,  -14,  13,   39,   64,   85,   103,  116,  125,  127,  121,  103,  75,   39,   0,    -40,  -76,  -104, -122,
    -128, -122, -104, -76,  -40,  -1,   39,   75,   103,  121,  127,  121,  103,  75,   39,   0,    -40,  -76,  -104,
    -122, -128, -122, -104, -76,  -40,  -1,   39,   75,   103,  121,  127,  121,  103,  75,   39,   0,    -40,  -76,
    -104, -122, -128, -122, -104, -76,  -40,  -1,   39,   75,   103,  121,  127,  116,  85,   39,   -14,  -65,  -104,
    -126, -126, -104, -64,  -14,  39,   85,   116,  127,  116,  85,   39,   -14,  -65,  -104, -126, -126, -104, -64,
    -14,  39,   85,   116,  127,  116,  85,   39,   -14,  -65,  -104, -126, -126, -104, -64,  -14,  39,   85,   116,
    127,  116,  85,   39,   -14,  -65,  -104, -126, -126, -104, -64,  -14,  39,   85,   116,  127,  121,  103,  75,
    39,   -1,   -40,  -76,  -104, -122, -128, -122, -104, -76,  -40,  0,    39,   75,   103,  121,  127,  121,  103,
    75,   39,   -1,   -40,  -76,  -104, -122, -128, -122, -104, -76,  -40,  0,    39,   75,   103,  121,  127,  121,
    103,  75,   39,   -1,   -40,  -76,  -104, -122, -128, -122, -104, -76,  -40,  0,    39,   75,   103,  121,  127,
    125,  116,  103,  85,   64,   39,   13,   -14,  -40,  -64,  -86,  -104, -117, -126, -128, -126, -117, -104, -86,
    -65,  -40,  -14,  13,   39,   64,   85,   103,  116,  125,  127,  125,  116,  103,  85,   64,   39,   13,   -14,
    -40,  -64,  -86,  -104, -117, -126, -128, -126, -117, -104, -86,  -64,  -40,  -14,  13,   39,   63,   85,   103,
    116,  125,  127,  127,  125,  121,  116,  110,  103,  95,   85,   75,   63,   52,   39,   26,   13,   -1,   -14,
    -27,  -40,  -53,  -65,  -76,  -86,  -96,  -104, -111, -117, -122, -126, -128, -128, -128, -126, -122, -117, -111,
    -104, -96,  -86,  -76,  -64,  -53,  -40,  -27,  -14,  -1,   13,   26,   39,   52,   63,   75,   85,   95,   103,
    110,  116,  121,  125,  127};

char W_imag[60 * 8] = {
    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,
    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,
    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,
    0,    0,    0,    0,    13,   26,   39,   52,   63,   75,   85,   95,   103,  110,  116,  121,  125,  127,  127,
    127,  125,  121,  116,  110,  103,  95,   85,   75,   63,   52,   39,   26,   13,   0,    -14,  -27,  -40,  -53,
    -64,  -76,  -86,  -96,  -104, -111, -117, -122, -126, -128, -128, -128, -126, -122, -117, -111, -104, -96,  -86,
    -76,  -64,  -53,  -40,  -27,  -14,  0,    26,   52,   75,   95,   110,  121,  127,  127,  121,  110,  95,   75,
    52,   26,   0,    -27,  -53,  -76,  -96,  -111, -122, -128, -128, -122, -111, -96,  -76,  -53,  -27,  -1,   26,
    52,   75,   95,   110,  121,  127,  127,  121,  110,  95,   75,   52,   26,   0,    -27,  -53,  -76,  -96,  -111,
    -122, -128, -128, -122, -111, -96,  -76,  -53,  -27,  0,    39,   75,   103,  121,  127,  121,  103,  75,   39,
    0,    -40,  -76,  -104, -122, -128, -122, -104, -76,  -40,  -1,   39,   75,   103,  121,  127,  121,  103,  75,
    39,   0,    -40,  -76,  -104, -122, -128, -122, -104, -76,  -40,  -1,   39,   75,   103,  121,  127,  121,  103,
    75,   39,   0,    -40,  -76,  -104, -122, -128, -122, -104, -76,  -40,  0,    -53,  -96,  -122, -128, -111, -76,
    -27,  26,   75,   110,  127,  121,  95,   52,   -1,   -53,  -96,  -122, -128, -111, -76,  -27,  26,   75,   110,
    127,  121,  95,   52,   -1,   -53,  -96,  -122, -128, -111, -76,  -27,  26,   75,   110,  127,  121,  95,   52,
    0,    -53,  -96,  -122, -128, -111, -76,  -27,  26,   75,   110,  127,  121,  95,   52,   0,    -40,  -76,  -104,
    -122, -128, -122, -104, -76,  -40,  0,    39,   75,   103,  121,  127,  121,  103,  75,   39,   -1,   -40,  -76,
    -104, -122, -128, -122, -104, -76,  -40,  0,    39,   75,   103,  121,  127,  121,  103,  75,   39,   -1,   -40,
    -76,  -104, -122, -128, -122, -104, -76,  -40,  0,    39,   75,   103,  121,  127,  121,  103,  75,   39,   0,
    -27,  -53,  -76,  -96,  -111, -122, -128, -128, -122, -111, -96,  -76,  -53,  -27,  -1,   26,   52,   75,   95,
    110,  121,  127,  127,  121,  110,  95,   75,   52,   26,   0,    -27,  -53,  -76,  -96,  -111, -122, -128, -128,
    -122, -111, -96,  -76,  -53,  -27,  0,    26,   52,   75,   95,   110,  121,  127,  127,  121,  110,  95,   75,
    52,   26,   0,    -14,  -27,  -40,  -53,  -65,  -76,  -86,  -96,  -104, -111, -117, -122, -126, -128, -128, -128,
    -126, -122, -117, -111, -104, -96,  -86,  -76,  -65,  -53,  -40,  -27,  -14,  0,    13,   26,   39,   52,   63,
    75,   85,   95,   103,  110,  116,  121,  125,  127,  127,  127,  125,  121,  116,  110,  103,  95,   85,   75,
    63,   52,   39,   26,   13};

/* 噪声估计算法，用频域带噪声信号的能量减去频域去噪声后的信号能量
 * 返回值：噪声功率
 * 去噪方法为：由于信号的能量主要集中在信道冲击响应（时域）的两侧，即主径，中间平坦部分为噪声，通过ifft算法得到信道冲击响应两侧各4个点的能量，即为去噪后的信号能量
 */
VENUS_INLINE long long noiseEstimate(__v4096i8 H_LS_real, __v4096i8 H_LS_imag, __v4096i8 W_real, __v4096i8 W_imag) {
  __v2048i16 shuffle_index;
  vclaim(shuffle_index);
  vrange(shuffle_index, 60 * 8);
  __v2048i16 const_value;
  vclaim(const_value);
  vbrdcst(const_value, 60, MASKREAD_OFF, 60 * 8);
  shuffle_index = vrem(const_value, shuffle_index, MASKREAD_OFF, 60 * 8);
  __v4096i8 X_real;
  vclaim(X_real);
  vshuffle(X_real, shuffle_index, H_LS_real, SHUFFLE_GATHER, 60 * 8);
  __v4096i8 X_imag;
  vclaim(X_imag);
  vshuffle(X_imag, shuffle_index, H_LS_imag, SHUFFLE_GATHER, 60 * 8);

  // __v4096i8 W_real;
  // __v4096i8 W_imag;

  vsetshamt(fractionLength);
  // vcmxmul(W_real, W_imag, X_real, X_imag, MASKREAD_OFF, 60 * 8);
  __v4096i8 tmp_real1;
  __v4096i8 tmp_real2;
  __v4096i8 tmp_imag1;
  __v4096i8 tmp_imag2;
  tmp_real1 = vmul(W_real, X_real, MASKREAD_OFF, 60 * 8);
  tmp_real2 = vmul(W_imag, X_imag, MASKREAD_OFF, 60 * 8);
  tmp_imag1 = vmul(W_real, X_imag, MASKREAD_OFF, 60 * 8);
  tmp_imag2 = vmul(W_imag, X_real, MASKREAD_OFF, 60 * 8);
  vsetshamt(0);
  W_real = vsub(tmp_real2, tmp_real1, MASKREAD_OFF, 60 * 8);
  W_imag = vadd(tmp_imag2, tmp_imag1, MASKREAD_OFF, 60 * 8);

  long long signal_plus_noise_power = 0;
  __v4096i8 tmp;
  __v4096i8 tmp_real;
  __v4096i8 tmp_imag;
  vsetshamt(fractionLength);
  tmp_real = vmul(H_LS_real, H_LS_real, MASKREAD_OFF, 60);
  tmp_imag = vmul(H_LS_imag, H_LS_imag, MASKREAD_OFF, 60);
  vsetshamt(0);
  tmp                   = vadd(tmp_real, tmp_imag, MASKREAD_OFF, 60);
  tmp                   = vredsum(tmp, MASKREAD_OFF, 60);
  short tmp_power_value = 0;
  int   tmp_addr        = vaddr(tmp);
  vbarrier();
  VSPM_OPEN();
  tmp_power_value = ((*(volatile char *)(tmp_addr)) & 0xFF);
  VSPM_CLOSE();
  tmp_addr = vaddr(tmp);
  vbarrier();
  VSPM_OPEN();
  tmp_power_value += (((*(volatile char *)(tmp_addr + 1)) & 0xFF) << 8);
  VSPM_CLOSE();
  tmp_addr = vaddr(tmp);
  vbarrier();
  VSPM_OPEN();
  tmp_power_value += (((*(volatile char *)(tmp_addr + 2)) & 0xFF) << 16);
  VSPM_CLOSE();
  tmp_addr = vaddr(tmp);
  vbarrier();
  VSPM_OPEN();
  tmp_power_value += (((*(volatile char *)(tmp_addr + 3)) & 0xFF) << 24);
  VSPM_CLOSE();
  signal_plus_noise_power = tmp_power_value;

  long long signal_power = 0;
  for (int i = 0; i < 8; i++) {
    vrange(shuffle_index, 60);
    shuffle_index = vadd(shuffle_index, 60 * i, MASKREAD_OFF, 60);
    vsetshamt(fractionLength);
    vshuffle(tmp_real, shuffle_index, W_real, SHUFFLE_GATHER, 60);
    vshuffle(tmp_imag, shuffle_index, W_imag, SHUFFLE_GATHER, 60);
    tmp_real = vredsum(tmp_real, MASKREAD_OFF, 60);
    tmp_imag = vredsum(tmp_imag, MASKREAD_OFF, 60);

    short tmp_power_value_real = 0;
    short tmp_power_value_imag = 0;
    int   tmp_addr             = vaddr(tmp_real);
    vbarrier();
    VSPM_OPEN();
    tmp_power_value_real = ((*(volatile char *)(tmp_addr)) & 0xFF);
    VSPM_CLOSE();
    tmp_addr = vaddr(tmp_real);
    vbarrier();
    VSPM_OPEN();
    tmp_power_value_real += (((*(volatile char *)(tmp_addr + 1)) & 0xFF) << 8);
    VSPM_CLOSE();
    tmp_addr = vaddr(tmp_real);
    vbarrier();
    VSPM_OPEN();
    tmp_power_value_real += (((*(volatile char *)(tmp_addr + 2)) & 0xFF) << 16);
    VSPM_CLOSE();
    tmp_addr = vaddr(tmp_real);
    vbarrier();
    VSPM_OPEN();
    tmp_power_value_real += (((*(volatile char *)(tmp_addr + 3)) & 0xFF) << 24);
    VSPM_CLOSE();

    tmp_addr = vaddr(tmp_imag);
    vbarrier();
    VSPM_OPEN();
    tmp_power_value_imag = ((*(volatile char *)(tmp_addr)) & 0xFF);
    VSPM_CLOSE();
    tmp_addr = vaddr(tmp_imag);
    vbarrier();
    VSPM_OPEN();
    tmp_power_value_imag += (((*(volatile char *)(tmp_addr + 1)) & 0xFF) << 8);
    VSPM_CLOSE();
    tmp_addr = vaddr(tmp_imag);
    vbarrier();
    VSPM_OPEN();
    tmp_power_value_imag += (((*(volatile char *)(tmp_addr + 2)) & 0xFF) << 16);
    VSPM_CLOSE();
    tmp_addr = vaddr(tmp_imag);
    vbarrier();
    VSPM_OPEN();
    tmp_power_value_imag += (((*(volatile char *)(tmp_addr + 3)) & 0xFF) << 24);
    VSPM_CLOSE();
    signal_power += (tmp_power_value_real * tmp_power_value_real + tmp_power_value_imag * tmp_power_value_imag);
  }

  long long noise_power = (signal_plus_noise_power - (signal_power / 60)) / 52 * 2;
  // long long noise_power = 0;
  return noise_power;
}

// 定点化乘法
VENUS_INLINE __v4096i8 MUL4096_16_VV(__v4096i8 a, __v4096i8 b, int fractionLength, int vmr, int vectorLength) {
  __v4096i8 high16;
  __v4096i8 low16;
  __v4096i8 result;
  if (vmr == MASKREAD_OFF) {
    low16  = vmul(a, b, MASKREAD_OFF, vectorLength);
    high16 = vmulh(a, b, MASKREAD_OFF, vectorLength);
    low16  = vsrl(low16, fractionLength, MASKREAD_OFF, vectorLength);
    high16 = vsll(high16, 16 - fractionLength, MASKREAD_OFF, vectorLength);
    result = vor(low16, high16, MASKREAD_OFF, vectorLength);
  } else {
    low16  = vmul(a, b, MASKREAD_ON, vectorLength);
    high16 = vmulh(a, b, MASKREAD_ON, vectorLength);
    low16  = vsrl(low16, fractionLength, MASKREAD_ON, vectorLength);
    high16 = vsll(high16, 16 - fractionLength, MASKREAD_ON, vectorLength);
    result = vor(low16, high16, MASKREAD_ON, vectorLength);
  }

  return result;
};

#define LEFT_SHIFT  0
#define RIGHT_SHIFT 1
VENUS_INLINE __v2048i16 cyclic_shift_2048_16(__v2048i16 tgtvec, int shift_length, int shift_direction,
                                             int vectorLength) {
  __v2048i16 result;
  __v2048i16 tmp_index;
  vclaim(tmp_index);
  __v2048i16 tmp_1;
  vclaim(tmp_1);
  vbrdcst(tmp_1, vectorLength, MASKREAD_OFF, vectorLength);
  vrange(tmp_index, vectorLength);
  tmp_index = vsadd(tmp_index, shift_direction == LEFT_SHIFT ? shift_length : (vectorLength - shift_length),
                    MASKREAD_OFF, vectorLength);
  tmp_index = vrem(tmp_1, tmp_index, MASKREAD_OFF, vectorLength);
  vclaim(result);
  vshuffle(result, tmp_index, tgtvec, SHUFFLE_GATHER, vectorLength);
  // vshuffle(retvec, tmp_index, tgtvec, SHUFFLE_GATHER, vectorLength);
  return result;
}

VENUS_INLINE __v4096i8 cyclic_shift_4096_8(__v4096i8 tgtvec, int shift_length, int shift_direction, int vectorLength) {
  __v4096i8  result;
  __v2048i16 tmp_index;
  vclaim(tmp_index);
  __v2048i16 tmp_1;
  vclaim(tmp_1);
  vbrdcst(tmp_1, vectorLength, MASKREAD_OFF, vectorLength);
  vrange(tmp_index, vectorLength);
  tmp_index = vsadd(tmp_index, shift_direction == LEFT_SHIFT ? shift_length : (vectorLength - shift_length),
                    MASKREAD_OFF, vectorLength);
  tmp_index = vrem(tmp_1, tmp_index, MASKREAD_OFF, vectorLength);
  vclaim(result);
  vshuffle(result, tmp_index, tgtvec, SHUFFLE_GATHER, vectorLength);
  // vshuffle(retvec, tmp_index, tgtvec, SHUFFLE_GATHER, vectorLength);
  return result;
}

VENUS_INLINE __v4096i16 cyclic_shift_4096_16(__v4096i16 tgtvec, int shift_length, int shift_direction,
                                             int vectorLength) {
  __v4096i16 result;
  __v4096i16 tmp_index;
  vclaim(tmp_index);
  __v4096i16 tmp_1;
  vclaim(tmp_1);
  vbrdcst(tmp_1, vectorLength, MASKREAD_OFF, vectorLength);
  vrange(tmp_index, vectorLength);
  tmp_index = vsadd(tmp_index, shift_direction == LEFT_SHIFT ? shift_length : (vectorLength - shift_length),
                    MASKREAD_OFF, vectorLength);
  tmp_index = vrem(tmp_1, tmp_index, MASKREAD_OFF, vectorLength);
  vclaim(result);
  vshuffle(result, tmp_index, tgtvec, SHUFFLE_GATHER, vectorLength);
  // vshuffle(retvec, tmp_index, tgtvec, SHUFFLE_GATHER, vectorLength);
  return result;
}
short subcarrierLength = 240;
short dmrs_interval    = 4;
// char input_rxData_real[720] = {
//     47,  -62, -63, -66, -64, -63, -65, 46,  -65, 43,  47,  -64, -58, -63, 51,
//     56,  -56, -58, 58,  -51, 59,  55,  63,  -44, -48, 65,  62,  -42, -42, 68,
//     67,  67,  -48, 64,  65,  -44, 62,  64,  -44, 62,  59,  61,  -43, 58, -51,
//     62,  -50, -50, 56,  63,  -55, -46, 56,  -53, 51,  64,  58,  60,  52, -58,
//     51,  -57, -60, 59,  -64, -65, 47,  -66, 54,  -64, -66, 53,  -64, 41, -55,
//     42,  -53, -51, -64, 57,  59,  59,  46,  -61, -47, -49, 50,  -46, -62, 62,
//     -61, 58,  -49, 40,  56,  -72, -58, -58, 49,  -78, -60, -61, -77, 50, -76,
//     -56, -73, -69, 58,  43,  62,  46,  -61, -41, 70,  53,  -36, -37, 56, -36,
//     41,  75,  -56, 70,  48,  63,  -64, 61,  63,  -70, -50, -73, -53, -72, 57,
//     -49, 38,  -49, -68, 64,  -62, 43,  44,  -41, 66,  67,  -43, 41,  -40, 62,
//     -66, -47, -69, -46, -52, 59,  -49, 58,  34,  -74, -76, 57,  -74, -72,
//     -69, 61,  40,  37,  -67, 39,  -41, -68, -42, 39,  61,  36,  37,  -47,
//     -47, -49, -52, -77, -53, -54, 24,  -81, 50,  -52, -84, -52, 28,  25, -81,
//     -49, -77, 56,  -48, -79, -47, -50, -51, 23,  -78, 54,  22,  -50, -83, 23,
//     -80, -83, -53, -54, -50, -78, -81, 25,  -76, -42, -44, 30,  31,  34,  63,
//     30,  -77, -44, -80, 25,  -47, -51, -54, -90, -54, -57, -93, -90, -92,
//     -92, -55, -88, 64,  41,  -65, 40,  40,  66,  -40, -41, -40, 37,  -70,
//     -41, 65,  -69, -40, -63, -69, -69, -71, 41,  -38, 38,  -42, 39,  36,  38,
//     38,  69,  -66, -66, -40, -37, 35,  39,  -67, 66,  -36, -68, 36,  -37,
//     -67, -69, 34,  -69, -65, -39, 39,  -40, -1,  -1,  -1,  0,   0,   -1,  -1,
//     0,   72,  73,  74,  75, 74,  72,  74,  74,  76,  72,  -76, 73,  71,  72,
//     73,  75,  -75, 71,  70, 75,  -72, 73,  -75, 72,  -76, 72,  73,  -75, -73,
//     71,  71,  73,  -71, -72, -73, 75,  -73, 73,  -76, 74,  73,  74,  73,  71,
//     70,  76,  -72, -72, 72, 70,  75,  -73, 73,  -71, -74, -72, -71, -74, -69,
//     -73, -73, 70,  -74, 76, 49,  -73, 71,  67,  72,  72,  -69, 72,  -70, -70,
//     74,  -68, -73, 71,  -74, 70,  -73, -69, -71, -73, 67,  69,  -73, -72,
//     -73, -75, 70,  69,  -69, -73, -70, -71, -70, 69,  69,  70,  -68, 72, -74,
//     68,  69,  67,  72,  68,  -70, -73, 67,  67,  72,  -71, 68,  66,  66, -71,
//     70,  67,  -70, -71, -72, 67, -70, -70, -71, -2,  -2,  0,   0,   -2,  -1,
//     0,   0,   -1,  22,  74,  -74, 22,  -74, 23,  72,  24,  -21, -74, 19,  22,
//     -74, 19,  -21, -21, 72,  -75, 19,  -73, -73, -78, -21, -22, 19,  -23, 76,
//     74,  -75, -76, 76,  77,  77, -74, -19, 77,  15,  19,  76,  74,  -17, -17,
//     -19, 17,  -21, -19, -17, 74, -74, -74, -71, 72,  -72, 25,  23,  -74, 72,
//     22,  26,  -74, 26,  72,  -73, 72,  -74, 23,  72,  71,  73,  74,  27,  24,
//     76,  72,  -76, 75,  -74, -25, 74,  -73, -23, -22, 75,  -22, -73, 72,  77,
//     -22, 20,  -21, 73,  77,  -23, 18,  75,  -21, 71,  17,  -21, -19, -76,
//     -75, -20, -19, -73, -20, 18,  72, -20, 74,  -20, 17,  74,  -17, 20,  17,
//     -76, -20, -74, 16,  17,  -77, -75, -77, 21,  73,  17,  -19, -16, 16, -76,
//     -15, -15, -16, 16,  -16, 77,  -19, -17, 13,  18,  -19, 76,  -78, 16,  78,
//     18,  72,  -75, -14, -78, 77,  -16, 13,  14,  13,  73,  -14, 77,  -76,
//     -77, -77, 13,  76,  74,  16,  -18, 15, -99, 76,  74,  11,  -15, 73,  -77,
//     -11, 78,  -76, 9,   -79, -12, 76,  -78, -10, -15, -78, -11, 9,   11, -12,
//     10,  7,   10,  -10, 8,   74,  -76, 80, -12, 76,  75,  9,   76,  -80, -79,
//     -80, -75, 77,  -79, 6,   -77, 75,  8, -10, 11,  8,   8,   -7,  -75, 75,
//     79,  6,   6,   -80, 6,   -9,  5,   -10, 6,   -8,  78,  4,   5,   5, -79,
//     79,  78,  3,   4,   -5,  -7,  76,  -80, 78,  75,  -79, -7,  2,   78, -79,
//     -80, 77,  -78, 3,   1,   2,   74,  -78, -78, 79,  78,  -1,  -1,  -3,  0,
//     1,   3,   1,   -79, 75,  -5,  78,  -1, 76,  2,   -5,  0,   1,   -75, 79,
//     -3,  -1,  0,   -78, 2,   73,  -76, -77};
// char input_rxData_imag[720] = {
//     -64, -62, -63, 50,  -58, -57, -54, -54, 52,  60,  58,  56,  -52, 58,  63,
//     -51, 55,  56,  -54, -56, -55, 52,  -60, -69, 41,  -66, 43,  -71, -76,
//     -71, -72, -70, 33,  -69, -68, -74, -65, -65, -66, -59, 49,  52,  -63, 59,
//     52, -48, 56,  57,  69,  -40, 63,  -46, 72,  64,  70,  -35, -34, -36, 72,
//     65, 70,  61,  59,  -38, 61,  61,  68,  59,  -42, 56,  55,  -43, 54,  66,
//     -58, 61,  -57, -61, 50,  -50, -50, -49, 58,  43,  -69, -71, 51,  -73, 40,
//     -61, 37,  -60, -77, 51,  -61, 33,  -75, -74, -57, 40,  -68, -68, 44, -49,
//     47, -64, 45,  51,  -44, 65,  -44, 66,  46,  -61, -44, 59,  -63, -68, 62,
//     -67, 40,  -53, 35,  -52, 54,  -49, 37,  -50, -47, 43,  -66, 45,  -64, 48,
//     -39, -64, 69,  -65, 44,  -44, 40,  63,  56,  -76, -54, -52, -82, 52, -81,
//     -60, 29,  -81, 32,  -77, -74, -50, -71, -41, 68,  46,  46,  -32, 54,  53,
//     52, -26, 79,  80,  53,  74,  -57, 49,  -65, 68,  -41, 64,  63,  -76, -73,
//     -73, -75, 32,  -74, -79, 56,  30,  -44, -71, 36,  -72, 66,  62,  36, -67,
//     38, -41, -67, 36,  -71, -68, -71, 62,  31,  -47, 61,  -72, 32,  65,  37,
//     36, -68, -67, -63, 42,  47,  74,  45,  -62, -62, 79,  76,  72,  -34, 72,
//     40, -70, 34,  69,  -74, -73, -74, 32,  -72, -77, 29,  30,  28,  32,  -72,
//     32, -41, 64,  37,  63,  63,  -39, -66, -71, -69, 64,  40,  -65, -39, 40,
//     -69, 40,  39,  39,  40,  65,  -64, 67,  -69, 63,  68,  65,  66,  -38, 38,
//     38, -65, -68, 67,  65,  36,  -36, -67, 39,  69,  -66, 34,  39,  67,  40,
//     35, -66, 67,  -69, 2,   0,   1,   -1,  0,   -1,  -1,  -1,  22,  23,  22,
//     20, 21,  24,  23,  22,  23,  24,  -23, 23,  25,  23,  27,  22,  -25, 24,
//     28, 24,  -25, 24,  -25, 26,  -24, 27,  25,  -27, -28, 25,  26,  27,  -27,
//     -28, -27, 24,  -27, 28,  -24, 23,  26,  26,  26,  27,  27,  28,  -28,
//     -29, 27, 29,  25,  -25, 27,  -30, -28, -30, -30, -27, -30, -29, -27, 28,
//     -27, 28, 18,  -32, 27,  30,  29,  28,  -30, 28,  -33, -32, 29,  -33, -30,
//     29,  -29, 31,  -31, -32, -33, -31, 33,  33,  -32, -32, -33, -32, 31,  34,
//     -33, -34, -34, -35, -34, 32,  34,  32,  -32, 29,  -33, 32,  31,  33,  33,
//     34,  -36, -33, 34,  36,  34,  -34, 33,  35,  34,  -34, 33,  34,  -34,
//     -36, -35, 35, -36, -37, -37, -1,  1,   -1,  0,   0,   -1,  -2,  -1,  0,
//     74,  -25, 24, 70,  23,  74,  -19, 75,  -75, 18,  75,  75,  20,  75,  -75,
//     -72, -20, 19, 71,  21,  21,  20,  -75, -73, 76,  -73, -22, -19, 17,  19,
//     -19, -18, -19, 21,  -78, -19, 74,  73,  -17, -17, -79, -78, -77, 74, -74,
//     -75, -76, -17, 26,  23,  24,  -26, 27,  71,  72,  22,  -25, 75,  70,  26,
//     75,  -28, 26, -23, 25,  75,  -26, -24, -25, -22, 75,  74,  -21, -25, 23,
//     -23, 23,  -73, -25, 22,  -76, -73, -20, -73, 20,  -20, -24, -76, 74, -72,
//     -24, -23, -74, 74,  -23, -73, -25, 72,  -74, -74, 21,  20,  -78, -73, 21,
//     -74, 75,  -23, -73, -21, -73, 72,  -19, -76, 76,  76,  19,  -76, 17,  74,
//     76,  18,  18, 16,  77,  -18, 71,  -77, -75, 79,  15,  -78, -76, -77, 75,
//     -77, -16, -76, -77, 75,  75,  -76, -16, 15,  77,  -16, 76,  -18, 17, -75,
//     15,  -17, -77, 74,  73,  76,  -17, -78, -13, 13,  15,  11,  73,  -15,
//     -17, 76,  -75, 74, 3,   -10, -15, 78,  -75, -12, 15,  -78, -13, 10,  75,
//     9,   -76, -11, 14, -77, -78, 14,  -79, 73,  75,  -77, 77,  78,  80,  -80,
//     77,  -12, 11,  -10, -76, -11, -9,  76,  -12, 7,   7,   5,   8,   -10, 9,
//     74,  9,   -10, 79, -78, 76,  76,  80,  -77, 6,   -8,  -7,  78,  78,  6,
//     77,  -75, 75,  -77, 76,  -77, -4,  75,  75,  73,  1,   -5,  -5,  75,  74,
//     -77, -75, -7,  5, -5,  -6,  6,   -77, 76,  -4,  0,   4,   -3,  2,   73,
//     78,  76,  -6,  1, 1,   -3,  -4,  76,  -79, -76, 78,  79,  77,  78,  4,
//     -3,  -77, -1,  -78, -1,  78,  -78, 80,  74,  4,   -2,  79,  -79, -77, 1,
//     76,  2,   -1,  -2};
// char input_dmrs_real[144] = {
//     -91, 90,  90,  90,  90,  -91, 90,  90,  90,  -91, -91, 90,  -91, -91,
//     -91, -91, 90,  -91, 90,  90,  -91, 90,  90,  90,  90,  90,  90,  -91, 90,
//     90, -91, -91, -91, 90,  -91, 90,  -91, 90,  90,  90,  90,  90,  90,  90,
//     -91, 90,  -91, 90,  90,  90,  90,  -91, 90,  90,  90,  -91, 90,  90,  90,
//     90, 90,  90,  -91, 90,  -91, -91, 90,  -91, 90,  -91, -91, -91, 90,  -91,
//     -91, -91, 90,  -91, 90,  -91, 90,  90,  -91, -91, 90,  90,  -91, -91, 90,
//     -91, -91, 90,  90,  90,  -91, 90,  -91, 90,  90,  90,  -91, 90,  -91,
//     -91, 90, 90,  -91, -91, -91, 90,  90,  -91, 90,  -91, 90,  90,  -91, 90,
//     90,  -91, -91, 90,  -91, 90,  90,  -91, -91, -91, -91, -91, -91, -91, 90,
//     -91, -91, 90,  -91, -91, -91, 90,  90,  -91, -91, -91};
// char input_dmrs_imag[144] = {
//     90,  90,  -91, 90,  -91, 90,  -91, 90,  -91, 90,  -91, -91, -91, -91, 90,
//     -91, -91, 90,  -91, 90,  90,  90,  -91, 90,  90,  90,  -91, 90,  -91, 90,
//     -91, -91, 90,  90,  -91, -91, 90,  90,  -91, 90,  -91, -91, -91, 90, -91,
//     90,  -91, -91, -91, 90,  90,  -91, -91, 90,  -91, -91, -91, 90,  90, -91,
//     -91, 90,  -91, -91, 90,  -91, 90,  90,  90,  -91, 90,  90,  90,  90, -91,
//     90,  -91, 90,  90,  90,  -91, 90,  -91, -91, -91, -91, 90,  -91, -91, 90,
//     90,  -91, 90,  -91, -91, 90,  90,  -91, -91, 90,  90,  -91, -91, -91, 90,
//     90,  90,  -91, -91, -91, 90,  90,  -91, 90,  -91, 90,  90,  90,  90, -91,
//     -91, -91, 90,  -91, -91, -91, -91, 90,  -91, -91, -91, 90,  90,  90,  90,
//     -91, 90,  90,  -91, -91, 90,  -91, -91, -91};
// short input_dmrs_index[144] = {
//     0,   4,   8,   12,  16,  20,  24,  28,  32,  36,  40,  44,  48,  52,  56,
//     60,  64,  68,  72,  76,  80,  84,  88,  92,  96,  100, 104, 108, 112,
//     116, 120, 124, 128, 132, 136, 140, 144, 148, 152, 156, 160, 164, 168,
//     172, 176, 180, 184, 188, 192, 196, 200, 204, 208, 212, 216, 220, 224,
//     228, 232, 236, 0,   4,   8,   12,  16,  20,  24,  28,  32,  36,  40,  44,
//     192, 196, 200, 204, 208, 212, 216, 220, 224, 228, 232, 236, 0,   4,   8,
//     12,  16,  20, 24,  28,  32,  36,  40,  44,  48,  52,  56,  60,  64,  68,
//     72,  76,  80, 84,  88,  92,  96,  100, 104, 108, 112, 116, 120, 124, 128,
//     132, 136, 140, 144, 148, 152, 156, 160, 164, 168, 172, 176, 180, 184,
//     188, 192, 196, 200, 204, 208, 212, 216, 220, 224, 228, 232, 236};
// char input_coef_h[4096] = {
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3,
//     0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3};

static long long noise_power_arry[2] = {0};

int Task_nrPBCHChannelEstimate(__v4096i8 rxData_real0, __v4096i8 rxData_imag0, __v4096i8 dmrs_real, __v4096i8 dmrs_imag,
                               __v2048i16 dmrs_index, __v4096i8 global_coef_h, __v2048i16 rxData_shuffle_index) {
  // int Task_nrPBCHChannelEstimate(__v4096i8 rxData_real, __v4096i8
  // rxData_imag, __v4096i8 dmrs_real, __v4096i8 dmrs_imag,
  //                                __v2048i16 dmrs_index, __v4096i8
  //                                global_coef_h, __v2048i16
  //                                rxData_shuffle_index,
  //                                __v4096i8 W_real, __v4096i8 W_imag) {

  __v4096i8 rxData_real;
  __v4096i8 rxData_imag;
  vclaim(rxData_real);
  vclaim(rxData_imag);
  vshuffle(rxData_real, rxData_shuffle_index, rxData_real0, SHUFFLE_GATHER, 720);
  vshuffle(rxData_imag, rxData_shuffle_index, rxData_imag0, SHUFFLE_GATHER, 720);
  __v2048i16 const_value;
  vclaim(const_value);
  vbrdcst(const_value, subcarrierLength, MASKREAD_OFF, 144);
  dmrs_index = vrem(const_value, dmrs_index, MASKREAD_OFF, 144);
  // init output
  __v4096i8  h_real;
  __v4096i8  h_imag;
  __v2048i16 global_shuffle_index_1;
  __v2048i16 global_shuffle_index_2;
  vclaim(h_real);
  vclaim(h_imag);
  vbrdcst(h_real, 1, MASKREAD_OFF, subcarrierLength);
  vbrdcst(h_imag, 1, MASKREAD_OFF, subcarrierLength);
  vclaim(global_shuffle_index_1);
  vclaim(global_shuffle_index_2);
  vrange(global_shuffle_index_1, subcarrierLength);
  vrange(global_shuffle_index_2, subcarrierLength);
  /************PBCH Symbol 1**********/
  {
    short dmrsRefLength = 60;

    /*--------------------split data & dmrs--------------------*/
    __v4096i8 symbol_rxData_real;
    __v4096i8 symbol_rxData_imag;
    vclaim(symbol_rxData_real);
    vclaim(symbol_rxData_imag);
    vshuffle(symbol_rxData_real, global_shuffle_index_1, rxData_real, SHUFFLE_GATHER, subcarrierLength);
    vshuffle(symbol_rxData_imag, global_shuffle_index_1, rxData_imag, SHUFFLE_GATHER, subcarrierLength);
    __v4096i8 symbol_dmrs_real;
    __v4096i8 symbol_dmrs_imag;
    vclaim(symbol_dmrs_real);
    vclaim(symbol_dmrs_imag);
    vshuffle(symbol_dmrs_real, global_shuffle_index_2, dmrs_real, SHUFFLE_GATHER, dmrsRefLength);
    vshuffle(symbol_dmrs_imag, global_shuffle_index_2, dmrs_imag, SHUFFLE_GATHER, dmrsRefLength);
    __v2048i16 symbol_dmrs_index;
    vclaim(symbol_dmrs_index);
    vshuffle(symbol_dmrs_index, global_shuffle_index_2, dmrs_index, SHUFFLE_GATHER, dmrsRefLength);

    /*--------------------obtain rx dmrs--------------------*/
    __v4096i8 rxDmrs_real;
    __v4096i8 rxDmrs_imag;
    vclaim(rxDmrs_real);
    vclaim(rxDmrs_imag);
    vshuffle(rxDmrs_real, symbol_dmrs_index, symbol_rxData_real, SHUFFLE_GATHER, dmrsRefLength);
    vshuffle(rxDmrs_imag, symbol_dmrs_index, symbol_rxData_imag, SHUFFLE_GATHER, dmrsRefLength);

    /*--------------------LS estimate--------------------*/
    __v4096i8 temp_h_real;
    __v4096i8 temp_h_imag;
    __v4096i8 ac_temp_h_real;
    __v4096i8 bd_temp_h_real;
    __v4096i8 ad_temp_h_imag;
    __v4096i8 bc_temp_h_imag;
    __v4096i8 c2_temp_h;
    __v4096i8 d2_temp_h;
    __v4096i8 c2_add_d2_temp_h;
    // rxDmrs./input_dmrs
    vsetshamt(fractionLength);
    ac_temp_h_real = vmul(rxDmrs_real, symbol_dmrs_real, MASKREAD_OFF, dmrsRefLength);
    bd_temp_h_real = vmul(rxDmrs_imag, symbol_dmrs_imag, MASKREAD_OFF, dmrsRefLength);
    vsetshamt(0);
    temp_h_real = vsadd(ac_temp_h_real, bd_temp_h_real, MASKREAD_OFF, dmrsRefLength);
    vsetshamt(fractionLength);

    ad_temp_h_imag = vmul(rxDmrs_real, symbol_dmrs_imag, MASKREAD_OFF, dmrsRefLength);
    bc_temp_h_imag = vmul(rxDmrs_imag, symbol_dmrs_real, MASKREAD_OFF, dmrsRefLength);
    vsetshamt(0);
    temp_h_imag = vssub(ad_temp_h_imag, bc_temp_h_imag, MASKREAD_OFF,
                        dmrsRefLength); // bc_temp_h_imag-ad_temp_h_imag

    /*--------------------noise estimate--------------------*/
    // noise_power_arry[0] = noiseEstimate(temp_h_real, temp_h_imag, W_real,
    // W_imag);

    /*--------------------linear interpolation--------------------*/
    __v4096i8 base_h_real;
    __v4096i8 base_h_imag;
    __v4096i8 weight_h_real;
    __v4096i8 weight_h_imag;
    __v4096i8 coef_h;

    // prepare weight
    __v4096i8 temp_h_shift_real;
    __v4096i8 temp_h_shift_imag;

    __v2048i16 tmp_index;
    vclaim(tmp_index);
    vrange(tmp_index, dmrsRefLength);
    __v2048i16 tmp_index_1;
    vclaim(tmp_index_1);
    vbrdcst(tmp_index_1, dmrsRefLength, MASKREAD_OFF, dmrsRefLength);
    tmp_index = vsadd(tmp_index, 1, MASKREAD_OFF, dmrsRefLength);
    tmp_index = vrem(tmp_index_1, tmp_index, MASKREAD_OFF, dmrsRefLength);
    vclaim(temp_h_shift_real);
    vshuffle(temp_h_shift_real, tmp_index, temp_h_real, SHUFFLE_GATHER, dmrsRefLength);
    temp_h_shift_real = cyclic_shift_4096_8(temp_h_real, 1, LEFT_SHIFT, dmrsRefLength);
    temp_h_shift_imag = cyclic_shift_4096_8(temp_h_imag, 1, LEFT_SHIFT, dmrsRefLength);
    weight_h_real     = vssub(temp_h_real, temp_h_shift_real, MASKREAD_OFF, dmrsRefLength);
    weight_h_imag     = vssub(temp_h_imag, temp_h_shift_imag, MASKREAD_OFF, dmrsRefLength);
    __v2048i16 dmrs_interval_index_vec;
    __v4096i8  dmrs_interval_vec;
    vclaim(dmrs_interval_vec);
    vclaim(dmrs_interval_index_vec);
    vbrdcst(dmrs_interval_vec, dmrs_interval, MASKREAD_OFF,
            subcarrierLength); // trick
    vbrdcst(dmrs_interval_index_vec, dmrs_interval, MASKREAD_OFF,
            subcarrierLength); // trick
    weight_h_real = vdiv(dmrs_interval_vec, weight_h_real, MASKREAD_OFF, dmrsRefLength);
    weight_h_imag = vdiv(dmrs_interval_vec, weight_h_imag, MASKREAD_OFF, dmrsRefLength);

    // obtian parameter
    __v2048i16 dmrs_shuffle_index;
    __v2048i16 base_dmrs_shuffle_index;
    __v2048i16 weight_dmrs_shuffle_index;
    vclaim(dmrs_shuffle_index);
    vrange(dmrs_shuffle_index, subcarrierLength);
    base_dmrs_shuffle_index   = vdiv(dmrs_interval_index_vec, dmrs_shuffle_index, MASKREAD_OFF, subcarrierLength);
    weight_dmrs_shuffle_index = vdiv(dmrs_interval_index_vec, dmrs_shuffle_index, MASKREAD_OFF, subcarrierLength);
    vclaim(coef_h);
    vbrdcst(coef_h, 0, MASKREAD_OFF, subcarrierLength);
    coef_h = vsadd(coef_h, global_coef_h, MASKREAD_OFF, subcarrierLength);
    // base_h和coef_h前几个位置特殊处理 weight_h前几个和后几个位置特殊处理
    short left_index = 0, right_index = 0;
    int   dmrs_index_addr = vaddr(symbol_dmrs_index);
    vbarrier();
    VSPM_OPEN();
    left_index = *(volatile short *)(dmrs_index_addr + (0 << 1));
    VSPM_CLOSE();
    dmrs_index_addr = vaddr(symbol_dmrs_index);
    vbarrier();
    VSPM_OPEN();
    right_index = *(volatile short *)(dmrs_index_addr + ((dmrsRefLength - 1) << 1));
    VSPM_CLOSE();
    // printf("res:%hd\n", &left_index);
    // printf("res:%hd\n", &right_index);
    base_dmrs_shuffle_index = cyclic_shift_2048_16(base_dmrs_shuffle_index, left_index, RIGHT_SHIFT, subcarrierLength);
    weight_dmrs_shuffle_index =
        cyclic_shift_2048_16(weight_dmrs_shuffle_index, left_index, RIGHT_SHIFT, subcarrierLength);
    coef_h                             = cyclic_shift_4096_8(coef_h, left_index, RIGHT_SHIFT, subcarrierLength);
    int base_dmrs_shuffle_index_addr   = vaddr(base_dmrs_shuffle_index);
    int weight_dmrs_shuffle_index_addr = vaddr(weight_dmrs_shuffle_index);
    int coef_h_addr                    = vaddr(coef_h);
    vbarrier();
    VSPM_OPEN();
    for (int i = 0; i < left_index; ++i) {
      *(volatile short *)(base_dmrs_shuffle_index_addr + (i << 1))   = 0;
      *(volatile short *)(weight_dmrs_shuffle_index_addr + (i << 1)) = 0;
      *(volatile char *)(coef_h_addr + i)                            = -(left_index - i);
    }
    // ERROR!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    weight_dmrs_shuffle_index_addr = vaddr(weight_dmrs_shuffle_index);
    for (int i = right_index; i < subcarrierLength; ++i) {
      *(volatile short *)(weight_dmrs_shuffle_index_addr + (i << 1)) = dmrsRefLength - 1 - 1;
    }
    VSPM_CLOSE();
    // printf("res:%hd\n", &left_index);
    // printf("res:%hd\n", &right_index);
    // VENUS_PRINTVEC_SHORT(weight_dmrs_shuffle_index, subcarrierLength);

    vclaim(base_h_real);
    vclaim(base_h_imag);
    vshuffle(base_h_real, base_dmrs_shuffle_index, temp_h_real, SHUFFLE_GATHER, subcarrierLength);
    vshuffle(base_h_imag, base_dmrs_shuffle_index, temp_h_imag, SHUFFLE_GATHER, subcarrierLength);
    __v4096i8 weight_h_real1;
    __v4096i8 weight_h_imag1;
    vclaim(weight_h_real1);
    vclaim(weight_h_imag1);
    vshuffle(weight_h_real1, weight_dmrs_shuffle_index, weight_h_real, SHUFFLE_GATHER, subcarrierLength);
    vshuffle(weight_h_imag1, weight_dmrs_shuffle_index, weight_h_imag, SHUFFLE_GATHER, subcarrierLength);

    __v4096i8 symbol_h_real;
    __v4096i8 symbol_h_imag;

    symbol_h_real = vmuladd(weight_h_real1, coef_h, base_h_real, MASKREAD_OFF, subcarrierLength);
    symbol_h_imag = vmuladd(weight_h_imag1, coef_h, base_h_imag, MASKREAD_OFF, subcarrierLength);
    vshuffle(h_real, global_shuffle_index_1, symbol_h_real, SHUFFLE_SCATTER, subcarrierLength);
    vshuffle(h_imag, global_shuffle_index_1, symbol_h_imag, SHUFFLE_SCATTER, subcarrierLength);
    // h_real = vmul(weight_h_real, coef_h, MASKREAD_OFF, subcarrierLength);
    // h_imag = vmul(weight_h_imag, coef_h, MASKREAD_OFF, subcarrierLength);
    // h_real = vsadd(base_h_real, h_real, MASKREAD_OFF, subcarrierLength);
    // h_imag = vsadd(base_h_imag, h_imag, MASKREAD_OFF, subcarrierLength);
    // VENUS_PRINTVEC_CHAR(h_real, subcarrierLength);
  }

  global_shuffle_index_1 = vsadd(global_shuffle_index_1, subcarrierLength, MASKREAD_OFF, subcarrierLength);
  global_shuffle_index_2 = vsadd(global_shuffle_index_2, 60, MASKREAD_OFF, subcarrierLength);

  /************PBCH Symbol 2**********/
  {
    int   partLength      = 48;
    int   secondPartStart = 192;
    short dmrsRefLength   = 12;

    /*--------------------split data & dmrs--------------------*/
    __v4096i8 symbol_rxData_real;
    __v4096i8 symbol_rxData_imag;
    vclaim(symbol_rxData_real);
    vclaim(symbol_rxData_imag);
    vshuffle(symbol_rxData_real, global_shuffle_index_1, rxData_real, SHUFFLE_GATHER, subcarrierLength);
    vshuffle(symbol_rxData_imag, global_shuffle_index_1, rxData_imag, SHUFFLE_GATHER, subcarrierLength);
    __v4096i8 symbol_dmrs_real;
    __v4096i8 symbol_dmrs_imag;
    vclaim(symbol_dmrs_real);
    vclaim(symbol_dmrs_imag);
    vshuffle(symbol_dmrs_real, global_shuffle_index_2, dmrs_real, SHUFFLE_GATHER, dmrsRefLength * 2);
    vshuffle(symbol_dmrs_imag, global_shuffle_index_2, dmrs_imag, SHUFFLE_GATHER, dmrsRefLength * 2);
    __v2048i16 symbol_dmrs_index;
    vclaim(symbol_dmrs_index);
    vshuffle(symbol_dmrs_index, global_shuffle_index_2, dmrs_index, SHUFFLE_GATHER, dmrsRefLength * 2);
    // VENUS_PRINTVEC_SHORT(symbol_dmrs_index, dmrsRefLength * 2);

    /*--------------------Temporary parameters--------------------*/
    __v4096i8 symbol_h_real;
    __v4096i8 symbol_h_imag;
    vclaim(symbol_h_real);
    vclaim(symbol_h_imag);
    vbrdcst(symbol_h_real, 1, MASKREAD_OFF, subcarrierLength);
    vbrdcst(symbol_h_imag, 1, MASKREAD_OFF, subcarrierLength);
    /************PBCH Symbol 2 part1**********/
    {

      /*--------------------split dmrs part1--------------------*/
      __v4096i8  dmrs_real_part1;
      __v4096i8  dmrs_imag_part1;
      __v2048i16 dmrs_index_part1;
      __v2048i16 dmrs_part1_shuffle_index;
      vclaim(dmrs_real_part1);
      vclaim(dmrs_imag_part1);
      vclaim(dmrs_index_part1);
      vclaim(dmrs_part1_shuffle_index);
      vrange(dmrs_part1_shuffle_index, dmrsRefLength);
      vshuffle(dmrs_real_part1, dmrs_part1_shuffle_index, symbol_dmrs_real, SHUFFLE_GATHER, dmrsRefLength);
      vshuffle(dmrs_imag_part1, dmrs_part1_shuffle_index, symbol_dmrs_imag, SHUFFLE_GATHER, dmrsRefLength);
      vshuffle(dmrs_index_part1, dmrs_part1_shuffle_index, symbol_dmrs_index, SHUFFLE_GATHER, dmrsRefLength);

      /*--------------------obtain rx dmrs--------------------*/
      __v4096i8 rxDmrs_real;
      __v4096i8 rxDmrs_imag;
      vclaim(rxDmrs_real);
      vclaim(rxDmrs_imag);
      vshuffle(rxDmrs_real, dmrs_index_part1, symbol_rxData_real, SHUFFLE_GATHER, dmrsRefLength);
      vshuffle(rxDmrs_imag, dmrs_index_part1, symbol_rxData_imag, SHUFFLE_GATHER, dmrsRefLength);

      /*--------------------LS estimate--------------------*/
      __v4096i8 temp_h_real;
      __v4096i8 temp_h_imag;
      __v4096i8 ac_temp_h_real;
      __v4096i8 bd_temp_h_real;
      __v4096i8 ad_temp_h_imag;
      __v4096i8 bc_temp_h_imag;
      __v4096i8 c2_temp_h;
      __v4096i8 d2_temp_h;
      __v4096i8 c2_add_d2_temp_h;
      // rxDmrs./input_dmrs
      vsetshamt(fractionLength);
      ac_temp_h_real = vmul(rxDmrs_real, dmrs_real_part1, MASKREAD_OFF, dmrsRefLength);
      bd_temp_h_real = vmul(rxDmrs_imag, dmrs_imag_part1, MASKREAD_OFF, dmrsRefLength);
      vsetshamt(0);
      temp_h_real = vsadd(ac_temp_h_real, bd_temp_h_real, MASKREAD_OFF, dmrsRefLength);
      vsetshamt(fractionLength);

      ad_temp_h_imag = vmul(rxDmrs_real, dmrs_imag_part1, MASKREAD_OFF, dmrsRefLength);
      bc_temp_h_imag = vmul(rxDmrs_imag, dmrs_real_part1, MASKREAD_OFF, dmrsRefLength);
      vsetshamt(0);
      temp_h_imag = vssub(ad_temp_h_imag, bc_temp_h_imag, MASKREAD_OFF,
                          dmrsRefLength); // bc_temp_h_imag - ad_temp_h_imag

      /*--------------------linear interpolation--------------------*/
      __v4096i8 base_h_real;
      __v4096i8 base_h_imag;
      __v4096i8 weight_h_real;
      __v4096i8 weight_h_imag;
      __v4096i8 coef_h;

      // prepare weight
      __v4096i8 temp_h_shift_real;
      __v4096i8 temp_h_shift_imag;

      __v2048i16 tmp_index;
      vclaim(tmp_index);
      vrange(tmp_index, dmrsRefLength);
      tmp_index = vsadd(tmp_index, 1, MASKREAD_OFF, dmrsRefLength);
      tmp_index = vrem(tmp_index, dmrsRefLength, MASKREAD_OFF, dmrsRefLength);
      vclaim(temp_h_shift_real);
      vshuffle(temp_h_shift_real, tmp_index, temp_h_real, SHUFFLE_GATHER, dmrsRefLength);
      temp_h_shift_real = cyclic_shift_4096_8(temp_h_real, 1, LEFT_SHIFT, dmrsRefLength);
      temp_h_shift_imag = cyclic_shift_4096_8(temp_h_imag, 1, LEFT_SHIFT, dmrsRefLength);
      weight_h_real     = vssub(temp_h_real, temp_h_shift_real, MASKREAD_OFF, dmrsRefLength);
      weight_h_imag     = vssub(temp_h_imag, temp_h_shift_imag, MASKREAD_OFF, dmrsRefLength);
      __v2048i16 dmrs_interval_index_vec;
      __v4096i8  dmrs_interval_vec;
      vclaim(dmrs_interval_vec);
      vclaim(dmrs_interval_index_vec);
      vbrdcst(dmrs_interval_vec, dmrs_interval, MASKREAD_OFF,
              subcarrierLength); // trick
      vbrdcst(dmrs_interval_index_vec, dmrs_interval, MASKREAD_OFF,
              subcarrierLength); // trick
      weight_h_real = vdiv(dmrs_interval_vec, weight_h_real, MASKREAD_OFF, dmrsRefLength);
      weight_h_imag = vdiv(dmrs_interval_vec, weight_h_imag, MASKREAD_OFF, dmrsRefLength);

      // obtian parameter
      __v2048i16 dmrs_shuffle_index;
      __v2048i16 base_dmrs_shuffle_index;
      __v2048i16 weight_dmrs_shuffle_index;
      vclaim(dmrs_shuffle_index);
      vrange(dmrs_shuffle_index, partLength);
      base_dmrs_shuffle_index   = vdiv(dmrs_interval_index_vec, dmrs_shuffle_index, MASKREAD_OFF, partLength);
      weight_dmrs_shuffle_index = vdiv(dmrs_interval_index_vec, dmrs_shuffle_index, MASKREAD_OFF, partLength);
      vclaim(coef_h);
      vbrdcst(coef_h, 0, MASKREAD_OFF, partLength);
      coef_h = vsadd(coef_h, global_coef_h, MASKREAD_OFF, partLength);
      // base_h和coef_h前几个位置特殊处理 weight_h前几个和后几个位置特殊处理
      short left_index = 0, right_index = 0;
      int   dmrs_index_addr = vaddr(dmrs_index_part1);
      vbarrier();
      VSPM_OPEN();
      left_index  = *(volatile short *)(dmrs_index_addr + (0 << 1));
      right_index = *(volatile short *)(dmrs_index_addr + ((dmrsRefLength - 1) << 1));
      VSPM_CLOSE();
      // printf("res:%hd\n", &left_index);
      // printf("res:%hd\n", &right_index);
      base_dmrs_shuffle_index   = cyclic_shift_2048_16(base_dmrs_shuffle_index, left_index, RIGHT_SHIFT, partLength);
      weight_dmrs_shuffle_index = cyclic_shift_2048_16(weight_dmrs_shuffle_index, left_index, RIGHT_SHIFT, partLength);
      coef_h                    = cyclic_shift_4096_8(coef_h, left_index, RIGHT_SHIFT, partLength);
      int base_dmrs_shuffle_index_addr   = vaddr(base_dmrs_shuffle_index);
      int weight_dmrs_shuffle_index_addr = vaddr(weight_dmrs_shuffle_index);
      int coef_h_addr                    = vaddr(coef_h);
      vbarrier();
      VSPM_OPEN();
      for (int i = 0; i < left_index; ++i) {
        *(volatile short *)(base_dmrs_shuffle_index_addr + (i << 1))   = 0;
        *(volatile short *)(weight_dmrs_shuffle_index_addr + (i << 1)) = 0;
        *(volatile char *)(coef_h_addr + i)                            = -(left_index - i);
      }
      // ERROR!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
      weight_dmrs_shuffle_index_addr = vaddr(weight_dmrs_shuffle_index);
      for (int i = right_index; i < partLength; ++i) {
        *(volatile short *)(weight_dmrs_shuffle_index_addr + (i << 1)) = dmrsRefLength - 1 - 1;
      }
      VSPM_CLOSE();
      // printf("res:%hd\n", &left_index);
      // printf("res:%hd\n", &right_index);
      // VENUS_PRINTVEC_SHORT(weight_dmrs_shuffle_index, partLength);

      vclaim(base_h_real);
      vclaim(base_h_imag);
      vshuffle(base_h_real, base_dmrs_shuffle_index, temp_h_real, SHUFFLE_GATHER, partLength);
      vshuffle(base_h_imag, base_dmrs_shuffle_index, temp_h_imag, SHUFFLE_GATHER, partLength);
      __v4096i8 weight_h_real1;
      __v4096i8 weight_h_imag1;
      vclaim(weight_h_real1);
      vclaim(weight_h_imag1);
      vshuffle(weight_h_real1, weight_dmrs_shuffle_index, weight_h_real, SHUFFLE_GATHER, partLength);
      vshuffle(weight_h_imag1, weight_dmrs_shuffle_index, weight_h_imag, SHUFFLE_GATHER, partLength);

      // __v4096i8 h_real;
      // __v4096i8 h_imag;

      __v4096i8  tmp_h_real;
      __v4096i8  tmp_h_imag;
      __v2048i16 h_index;
      vclaim(h_index);
      vrange(h_index, partLength);
      tmp_h_real = vmuladd(weight_h_real1, coef_h, base_h_real, MASKREAD_OFF, partLength);
      tmp_h_imag = vmuladd(weight_h_imag1, coef_h, base_h_imag, MASKREAD_OFF, partLength);
      vshuffle(symbol_h_real, h_index, tmp_h_real, SHUFFLE_SCATTER, partLength);
      vshuffle(symbol_h_imag, h_index, tmp_h_imag, SHUFFLE_SCATTER, partLength);
    }

    /************PBCH Symbol 2 part2**********/
    {
      /*--------------------split dmrs part2--------------------*/
      __v4096i8  dmrs_real_part2;
      __v4096i8  dmrs_imag_part2;
      __v2048i16 dmrs_index_part2;
      __v2048i16 dmrs_part2_shuffle_index;
      vclaim(dmrs_real_part2);
      vclaim(dmrs_imag_part2);
      vclaim(dmrs_index_part2);
      vclaim(dmrs_part2_shuffle_index);
      vrange(dmrs_part2_shuffle_index, dmrsRefLength);
      dmrs_part2_shuffle_index = vsadd(dmrs_part2_shuffle_index, dmrsRefLength, MASKREAD_OFF, dmrsRefLength);
      vshuffle(dmrs_real_part2, dmrs_part2_shuffle_index, symbol_dmrs_real, SHUFFLE_GATHER, dmrsRefLength);
      vshuffle(dmrs_imag_part2, dmrs_part2_shuffle_index, symbol_dmrs_imag, SHUFFLE_GATHER, dmrsRefLength);
      vshuffle(dmrs_index_part2, dmrs_part2_shuffle_index, symbol_dmrs_index, SHUFFLE_GATHER, dmrsRefLength);

      /*--------------------obtain rx dmrs--------------------*/
      __v4096i8 rxDmrs_real;
      __v4096i8 rxDmrs_imag;
      vclaim(rxDmrs_real);
      vclaim(rxDmrs_imag);
      vshuffle(rxDmrs_real, dmrs_index_part2, symbol_rxData_real, SHUFFLE_GATHER, dmrsRefLength);
      vshuffle(rxDmrs_imag, dmrs_index_part2, symbol_rxData_imag, SHUFFLE_GATHER, dmrsRefLength);

      /*--------------------LS estimate--------------------*/
      __v4096i8 temp_h_real;
      __v4096i8 temp_h_imag;
      __v4096i8 ac_temp_h_real;
      __v4096i8 bd_temp_h_real;
      __v4096i8 ad_temp_h_imag;
      __v4096i8 bc_temp_h_imag;
      __v4096i8 c2_temp_h;
      __v4096i8 d2_temp_h;
      __v4096i8 c2_add_d2_temp_h;
      // rxDmrs./input_dmrs
      vsetshamt(fractionLength);
      ac_temp_h_real = vmul(rxDmrs_real, dmrs_real_part2, MASKREAD_OFF, dmrsRefLength);
      bd_temp_h_real = vmul(rxDmrs_imag, dmrs_imag_part2, MASKREAD_OFF, dmrsRefLength);
      vsetshamt(0);
      temp_h_real = vsadd(ac_temp_h_real, bd_temp_h_real, MASKREAD_OFF, dmrsRefLength);
      vsetshamt(fractionLength);

      ad_temp_h_imag = vmul(rxDmrs_real, dmrs_imag_part2, MASKREAD_OFF, dmrsRefLength);
      bc_temp_h_imag = vmul(rxDmrs_imag, dmrs_real_part2, MASKREAD_OFF, dmrsRefLength);
      vsetshamt(0);
      temp_h_imag = vssub(ad_temp_h_imag, bc_temp_h_imag, MASKREAD_OFF,
                          dmrsRefLength); // bc_temp_h_imag - ad_temp_h_imag

      /*--------------------linear interpolation--------------------*/
      __v4096i8 base_h_real;
      __v4096i8 base_h_imag;
      __v4096i8 weight_h_real;
      __v4096i8 weight_h_imag;
      __v4096i8 coef_h;

      // prepare weight
      __v4096i8 temp_h_shift_real;
      __v4096i8 temp_h_shift_imag;

      __v2048i16 tmp_index;
      vclaim(tmp_index);
      vrange(tmp_index, dmrsRefLength);
      tmp_index = vsadd(tmp_index, 1, MASKREAD_OFF, dmrsRefLength);
      tmp_index = vrem(tmp_index, dmrsRefLength, MASKREAD_OFF, dmrsRefLength);
      vclaim(temp_h_shift_real);
      vshuffle(temp_h_shift_real, tmp_index, temp_h_real, SHUFFLE_GATHER, dmrsRefLength);
      temp_h_shift_real = cyclic_shift_4096_8(temp_h_real, 1, LEFT_SHIFT, dmrsRefLength);
      temp_h_shift_imag = cyclic_shift_4096_8(temp_h_imag, 1, LEFT_SHIFT, dmrsRefLength);
      weight_h_real     = vssub(temp_h_real, temp_h_shift_real, MASKREAD_OFF, dmrsRefLength);
      weight_h_imag     = vssub(temp_h_imag, temp_h_shift_imag, MASKREAD_OFF, dmrsRefLength);
      __v2048i16 dmrs_interval_index_vec;
      __v4096i8  dmrs_interval_vec;
      vclaim(dmrs_interval_vec);
      vclaim(dmrs_interval_index_vec);
      vbrdcst(dmrs_interval_vec, dmrs_interval, MASKREAD_OFF,
              subcarrierLength); // trick
      vbrdcst(dmrs_interval_index_vec, dmrs_interval, MASKREAD_OFF,
              subcarrierLength); // trick
      weight_h_real = vdiv(dmrs_interval_vec, weight_h_real, MASKREAD_OFF, dmrsRefLength);
      weight_h_imag = vdiv(dmrs_interval_vec, weight_h_imag, MASKREAD_OFF, dmrsRefLength);

      // obtian parameter
      __v2048i16 dmrs_shuffle_index;
      __v2048i16 base_dmrs_shuffle_index;
      __v2048i16 weight_dmrs_shuffle_index;
      vclaim(dmrs_shuffle_index);
      vrange(dmrs_shuffle_index, partLength);
      base_dmrs_shuffle_index   = vdiv(dmrs_interval_index_vec, dmrs_shuffle_index, MASKREAD_OFF, partLength);
      weight_dmrs_shuffle_index = vdiv(dmrs_interval_index_vec, dmrs_shuffle_index, MASKREAD_OFF, partLength);
      vclaim(coef_h);
      vbrdcst(coef_h, 0, MASKREAD_OFF, partLength);
      coef_h = vsadd(coef_h, global_coef_h, MASKREAD_OFF, partLength);
      // base_h和coef_h前几个位置特殊处理 weight_h前几个和后几个位置特殊处理
      short left_index = 0, right_index = 0;
      int   dmrs_index_addr = vaddr(dmrs_index_part2);
      vbarrier();
      VSPM_OPEN();
      left_index = *(volatile short *)(dmrs_index_addr + (0 << 1)) - secondPartStart;
      VSPM_CLOSE();
      dmrs_index_addr = vaddr(dmrs_index_part2);
      vbarrier();
      VSPM_OPEN();
      right_index = *(volatile short *)(dmrs_index_addr + ((dmrsRefLength - 1) << 1)) - secondPartStart;
      VSPM_CLOSE();
      // printf("res:%hd\n", &left_index);
      // printf("res:%hd\n", &right_index);
      base_dmrs_shuffle_index   = cyclic_shift_2048_16(base_dmrs_shuffle_index, left_index, RIGHT_SHIFT, partLength);
      weight_dmrs_shuffle_index = cyclic_shift_2048_16(weight_dmrs_shuffle_index, left_index, RIGHT_SHIFT, partLength);
      coef_h                    = cyclic_shift_4096_8(coef_h, left_index, RIGHT_SHIFT, partLength);
      int base_dmrs_shuffle_index_addr   = vaddr(base_dmrs_shuffle_index);
      int weight_dmrs_shuffle_index_addr = vaddr(weight_dmrs_shuffle_index);
      int coef_h_addr                    = vaddr(coef_h);
      vbarrier();
      VSPM_OPEN();
      for (int i = 0; i < left_index; ++i) {
        *(volatile short *)(base_dmrs_shuffle_index_addr + (i << 1))   = 0;
        *(volatile short *)(weight_dmrs_shuffle_index_addr + (i << 1)) = 0;
        *(volatile char *)(coef_h_addr + i)                            = -(left_index - i);
      }
      // ERROR!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
      weight_dmrs_shuffle_index_addr = vaddr(weight_dmrs_shuffle_index);
      for (int i = right_index; i < partLength; ++i) {
        *(volatile short *)(weight_dmrs_shuffle_index_addr + (i << 1)) = dmrsRefLength - 1 - 1;
      }
      VSPM_CLOSE();
      // printf("res:%hd\n", &left_index);
      // printf("res:%hd\n", &right_index);
      // VENUS_PRINTVEC_SHORT(weight_dmrs_shuffle_index, partLength);

      vclaim(base_h_real);
      vclaim(base_h_imag);
      vshuffle(base_h_real, base_dmrs_shuffle_index, temp_h_real, SHUFFLE_GATHER, partLength);
      vshuffle(base_h_imag, base_dmrs_shuffle_index, temp_h_imag, SHUFFLE_GATHER, partLength);
      __v4096i8 weight_h_real1;
      __v4096i8 weight_h_imag1;
      vclaim(weight_h_real1);
      vclaim(weight_h_imag1);
      vshuffle(weight_h_real1, weight_dmrs_shuffle_index, weight_h_real, SHUFFLE_GATHER, partLength);
      vshuffle(weight_h_imag1, weight_dmrs_shuffle_index, weight_h_imag, SHUFFLE_GATHER, partLength);

      __v4096i8  tmp_h_real;
      __v4096i8  tmp_h_imag;
      __v2048i16 h_index;
      vclaim(h_index);
      vrange(h_index, partLength);
      h_index    = vsadd(h_index, secondPartStart, MASKREAD_OFF, partLength);
      tmp_h_real = vmuladd(weight_h_real1, coef_h, base_h_real, MASKREAD_OFF, partLength);
      tmp_h_imag = vmuladd(weight_h_imag1, coef_h, base_h_imag, MASKREAD_OFF, partLength);
      vshuffle(symbol_h_real, h_index, tmp_h_real, SHUFFLE_SCATTER, partLength);
      vshuffle(symbol_h_imag, h_index, tmp_h_imag, SHUFFLE_SCATTER, partLength);
    }
    vshuffle(h_real, global_shuffle_index_1, symbol_h_real, SHUFFLE_SCATTER, subcarrierLength);
    vshuffle(h_imag, global_shuffle_index_1, symbol_h_imag, SHUFFLE_SCATTER, subcarrierLength);
  }

  global_shuffle_index_1 = vsadd(global_shuffle_index_1, subcarrierLength, MASKREAD_OFF, subcarrierLength);
  global_shuffle_index_2 = vsadd(global_shuffle_index_2, 24, MASKREAD_OFF, subcarrierLength);

  /************PBCH Symbol 3**********/
  {
    short dmrsRefLength = 60;

    /*--------------------split data & dmrs--------------------*/
    __v4096i8 symbol_rxData_real;
    __v4096i8 symbol_rxData_imag;
    vclaim(symbol_rxData_real);
    vclaim(symbol_rxData_imag);
    vshuffle(symbol_rxData_real, global_shuffle_index_1, rxData_real, SHUFFLE_GATHER, subcarrierLength);
    vshuffle(symbol_rxData_imag, global_shuffle_index_1, rxData_imag, SHUFFLE_GATHER, subcarrierLength);
    __v4096i8 symbol_dmrs_real;
    __v4096i8 symbol_dmrs_imag;
    vclaim(symbol_dmrs_real);
    vclaim(symbol_dmrs_imag);
    vshuffle(symbol_dmrs_real, global_shuffle_index_2, dmrs_real, SHUFFLE_GATHER, dmrsRefLength);
    vshuffle(symbol_dmrs_imag, global_shuffle_index_2, dmrs_imag, SHUFFLE_GATHER, dmrsRefLength);
    __v2048i16 symbol_dmrs_index;
    vclaim(symbol_dmrs_index);
    vshuffle(symbol_dmrs_index, global_shuffle_index_2, dmrs_index, SHUFFLE_GATHER, dmrsRefLength);
    // VENUS_PRINTVEC_SHORT(symbol_dmrs_index, dmrsRefLength);

    /*--------------------obtain rx dmrs--------------------*/
    __v4096i8 rxDmrs_real;
    __v4096i8 rxDmrs_imag;
    vclaim(rxDmrs_real);
    vclaim(rxDmrs_imag);
    vshuffle(rxDmrs_real, symbol_dmrs_index, symbol_rxData_real, SHUFFLE_GATHER, dmrsRefLength);
    vshuffle(rxDmrs_imag, symbol_dmrs_index, symbol_rxData_imag, SHUFFLE_GATHER, dmrsRefLength);

    /*--------------------LS estimate--------------------*/
    __v4096i8 temp_h_real;
    __v4096i8 temp_h_imag;
    __v4096i8 ac_temp_h_real;
    __v4096i8 bd_temp_h_real;
    __v4096i8 ad_temp_h_imag;
    __v4096i8 bc_temp_h_imag;
    __v4096i8 c2_temp_h;
    __v4096i8 d2_temp_h;
    __v4096i8 c2_add_d2_temp_h;
    // rxDmrs./input_dmrs
    vsetshamt(fractionLength);
    ac_temp_h_real = vmul(rxDmrs_real, symbol_dmrs_real, MASKREAD_OFF, dmrsRefLength);
    bd_temp_h_real = vmul(rxDmrs_imag, symbol_dmrs_imag, MASKREAD_OFF, dmrsRefLength);
    vsetshamt(0);
    temp_h_real = vsadd(ac_temp_h_real, bd_temp_h_real, MASKREAD_OFF, dmrsRefLength);
    vsetshamt(fractionLength);

    ad_temp_h_imag = vmul(rxDmrs_real, symbol_dmrs_imag, MASKREAD_OFF, dmrsRefLength);
    bc_temp_h_imag = vmul(rxDmrs_imag, symbol_dmrs_real, MASKREAD_OFF, dmrsRefLength);
    vsetshamt(0);
    temp_h_imag = vssub(ad_temp_h_imag, bc_temp_h_imag, MASKREAD_OFF,
                        dmrsRefLength); // bc_temp_h_imag-ad_temp_h_imag

    /*--------------------noise estimate--------------------*/
    // noise_power_arry[1] = noiseEstimate(temp_h_real, temp_h_imag, W_real,
    // W_imag);

    /*--------------------linear interpolation--------------------*/
    __v4096i8 base_h_real;
    __v4096i8 base_h_imag;
    __v4096i8 weight_h_real;
    __v4096i8 weight_h_imag;
    __v4096i8 coef_h;

    // prepare weight
    __v4096i8 temp_h_shift_real;
    __v4096i8 temp_h_shift_imag;

    __v2048i16 tmp_index;
    vclaim(tmp_index);
    vrange(tmp_index, dmrsRefLength);
    __v2048i16 tmp_index_1;
    vclaim(tmp_index_1);
    vbrdcst(tmp_index_1, dmrsRefLength, MASKREAD_OFF, dmrsRefLength);
    tmp_index = vsadd(tmp_index, 1, MASKREAD_OFF, dmrsRefLength);
    tmp_index = vrem(tmp_index_1, tmp_index, MASKREAD_OFF, dmrsRefLength);
    vclaim(temp_h_shift_real);
    vshuffle(temp_h_shift_real, tmp_index, temp_h_real, SHUFFLE_GATHER, dmrsRefLength);
    temp_h_shift_real = cyclic_shift_4096_8(temp_h_real, 1, LEFT_SHIFT, dmrsRefLength);
    temp_h_shift_imag = cyclic_shift_4096_8(temp_h_imag, 1, LEFT_SHIFT, dmrsRefLength);
    weight_h_real     = vssub(temp_h_real, temp_h_shift_real, MASKREAD_OFF, dmrsRefLength);
    weight_h_imag     = vssub(temp_h_imag, temp_h_shift_imag, MASKREAD_OFF, dmrsRefLength);
    __v2048i16 dmrs_interval_index_vec;
    __v4096i8  dmrs_interval_vec;
    vclaim(dmrs_interval_vec);
    vclaim(dmrs_interval_index_vec);
    vbrdcst(dmrs_interval_vec, dmrs_interval, MASKREAD_OFF,
            subcarrierLength); // trick
    vbrdcst(dmrs_interval_index_vec, dmrs_interval, MASKREAD_OFF,
            subcarrierLength); // trick
    weight_h_real = vdiv(dmrs_interval_vec, weight_h_real, MASKREAD_OFF, dmrsRefLength);
    weight_h_imag = vdiv(dmrs_interval_vec, weight_h_imag, MASKREAD_OFF, dmrsRefLength);

    // obtian parameter
    __v2048i16 dmrs_shuffle_index;
    __v2048i16 base_dmrs_shuffle_index;
    __v2048i16 weight_dmrs_shuffle_index;
    vclaim(dmrs_shuffle_index);
    vrange(dmrs_shuffle_index, subcarrierLength);
    base_dmrs_shuffle_index   = vdiv(dmrs_interval_index_vec, dmrs_shuffle_index, MASKREAD_OFF, subcarrierLength);
    weight_dmrs_shuffle_index = vdiv(dmrs_interval_index_vec, dmrs_shuffle_index, MASKREAD_OFF, subcarrierLength);
    vclaim(coef_h);
    vbrdcst(coef_h, 0, MASKREAD_OFF, subcarrierLength);
    coef_h = vsadd(coef_h, global_coef_h, MASKREAD_OFF, subcarrierLength);
    // base_h和coef_h前几个位置特殊处理 weight_h前几个和后几个位置特殊处理
    short left_index = 0, right_index = 0;
    int   dmrs_index_addr = vaddr(symbol_dmrs_index);
    vbarrier();
    VSPM_OPEN();
    left_index = *(volatile short *)(dmrs_index_addr + (0 << 1));
    VSPM_CLOSE();
    dmrs_index_addr = vaddr(symbol_dmrs_index);
    vbarrier();
    VSPM_OPEN();
    right_index = *(volatile short *)(dmrs_index_addr + ((dmrsRefLength - 1) << 1));
    VSPM_CLOSE();
    // printf("res:%hd\n", &left_index);
    // printf("res:%hd\n", &right_index);
    base_dmrs_shuffle_index = cyclic_shift_2048_16(base_dmrs_shuffle_index, left_index, RIGHT_SHIFT, subcarrierLength);
    weight_dmrs_shuffle_index =
        cyclic_shift_2048_16(weight_dmrs_shuffle_index, left_index, RIGHT_SHIFT, subcarrierLength);
    coef_h                             = cyclic_shift_4096_8(coef_h, left_index, RIGHT_SHIFT, subcarrierLength);
    int base_dmrs_shuffle_index_addr   = vaddr(base_dmrs_shuffle_index);
    int weight_dmrs_shuffle_index_addr = vaddr(weight_dmrs_shuffle_index);
    int coef_h_addr                    = vaddr(coef_h);
    vbarrier();
    VSPM_OPEN();
    for (int i = 0; i < left_index; ++i) {
      *(volatile short *)(base_dmrs_shuffle_index_addr + (i << 1))   = 0;
      *(volatile short *)(weight_dmrs_shuffle_index_addr + (i << 1)) = 0;
      *(volatile char *)(coef_h_addr + i)                            = -(left_index - i);
    }
    // ERROR!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    weight_dmrs_shuffle_index_addr = vaddr(weight_dmrs_shuffle_index);
    for (int i = right_index; i < subcarrierLength; ++i) {
      *(volatile short *)(weight_dmrs_shuffle_index_addr + (i << 1)) = dmrsRefLength - 1 - 1;
    }
    VSPM_CLOSE();
    // printf("res:%hd\n", &left_index);
    // printf("res:%hd\n", &right_index);
    // VENUS_PRINTVEC_SHORT(weight_dmrs_shuffle_index, subcarrierLength);

    vclaim(base_h_real);
    vclaim(base_h_imag);
    vshuffle(base_h_real, base_dmrs_shuffle_index, temp_h_real, SHUFFLE_GATHER, subcarrierLength);
    vshuffle(base_h_imag, base_dmrs_shuffle_index, temp_h_imag, SHUFFLE_GATHER, subcarrierLength);
    __v4096i8 weight_h_real1;
    __v4096i8 weight_h_imag1;
    vclaim(weight_h_real1);
    vclaim(weight_h_imag1);
    vshuffle(weight_h_real1, weight_dmrs_shuffle_index, weight_h_real, SHUFFLE_GATHER, subcarrierLength);
    vshuffle(weight_h_imag1, weight_dmrs_shuffle_index, weight_h_imag, SHUFFLE_GATHER, subcarrierLength);

    __v4096i8 symbol_h_real;
    __v4096i8 symbol_h_imag;

    symbol_h_real = vmuladd(weight_h_real1, coef_h, base_h_real, MASKREAD_OFF, subcarrierLength);
    symbol_h_imag = vmuladd(weight_h_imag1, coef_h, base_h_imag, MASKREAD_OFF, subcarrierLength);
    vshuffle(h_real, global_shuffle_index_1, symbol_h_real, SHUFFLE_SCATTER, subcarrierLength);
    vshuffle(h_imag, global_shuffle_index_1, symbol_h_imag, SHUFFLE_SCATTER, subcarrierLength);
    // h_real = vmul(weight_h_real, coef_h, MASKREAD_OFF, subcarrierLength);
    // h_imag = vmul(weight_h_imag, coef_h, MASKREAD_OFF, subcarrierLength);
    // h_real = vsadd(base_h_real, h_real, MASKREAD_OFF, subcarrierLength);
    // h_imag = vsadd(base_h_imag, h_imag, MASKREAD_OFF, subcarrierLength);
    // VENUS_PRINTVEC_SHORT(h_real, subcarrierLength);
  }

  // long long noise_power = (noise_power_arry[0] + noise_power_arry[1]) >> 2;
  // vreturn(h_real, subcarrierLength * 3, h_imag, subcarrierLength * 3,
  // &noise_power, sizeof(noise_power));
  vreturn(h_real, subcarrierLength * 3, h_imag, subcarrierLength * 3);
}