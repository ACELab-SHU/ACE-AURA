/**
 * changeLog
 *
 * @version 0.1
 * @data:2024/07/24
 * @author: shenyihao
 * @descration: NR OFDM Phase Compensation
 *
 * @version 0.2
 * @data:2024/12/18
 * @author: yuanfeng
 * @descration: 修改了一些30KHz子载波下的BUG
 *
 * Copyright (c) 2024 by ACE_Lab, All Rights Reserved.
 */
#include "data_type.h"
#include "riscv_printf.h"
#include "venus.h"
#include <stdint.h>

typedef short __v2048i16 __attribute__((ext_vector_type(2048)));
typedef char  __v4096i8 __attribute__((ext_vector_type(4096)));

// 存cos和sin
char cos_table[720] = {
    127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  126,
    126,  126,  126,  126,  125,  125,  125,  125,  124,  124,  124,  124,  123,  123,  123,  122,  122,  122,  121,
    121,  121,  120,  120,  119,  119,  119,  118,  118,  117,  117,  116,  116,  116,  115,  115,  114,  114,  113,
    112,  112,  111,  111,  110,  110,  109,  109,  108,  107,  107,  106,  105,  105,  104,  104,  103,  102,  102,
    101,  100,  99,   99,   98,   97,   97,   96,   95,   94,   94,   93,   92,   91,   91,   90,   89,   88,   87,
    86,   86,   85,   84,   83,   82,   81,   81,   80,   79,   78,   77,   76,   75,   74,   73,   72,   72,   71,
    70,   69,   68,   67,   66,   65,   64,   63,   62,   61,   60,   59,   58,   57,   56,   55,   54,   53,   52,
    51,   50,   49,   48,   47,   46,   45,   44,   43,   42,   41,   40,   38,   37,   36,   35,   34,   33,   32,
    31,   30,   29,   28,   27,   26,   24,   23,   22,   21,   20,   19,   18,   17,   16,   14,   13,   12,   11,
    10,   9,    8,    7,    6,    4,    3,    2,    1,    0,    -1,   -2,   -3,   -4,   -6,   -7,   -8,   -9,   -10,
    -11,  -12,  -13,  -14,  -16,  -17,  -18,  -19,  -20,  -21,  -22,  -23,  -24,  -26,  -27,  -28,  -29,  -30,  -31,
    -32,  -33,  -34,  -35,  -36,  -37,  -38,  -40,  -41,  -42,  -43,  -44,  -45,  -46,  -47,  -48,  -49,  -50,  -51,
    -52,  -53,  -54,  -55,  -56,  -57,  -58,  -59,  -60,  -61,  -62,  -63,  -64,  -65,  -66,  -67,  -68,  -69,  -70,
    -71,  -72,  -72,  -73,  -74,  -75,  -76,  -77,  -78,  -79,  -80,  -81,  -81,  -82,  -83,  -84,  -85,  -86,  -86,
    -87,  -88,  -89,  -90,  -91,  -91,  -92,  -93,  -94,  -94,  -95,  -96,  -97,  -97,  -98,  -99,  -99,  -100, -101,
    -102, -102, -103, -104, -104, -105, -105, -106, -107, -107, -108, -109, -109, -110, -110, -111, -111, -112, -112,
    -113, -114, -114, -115, -115, -116, -116, -116, -117, -117, -118, -118, -119, -119, -119, -120, -120, -121, -121,
    -121, -122, -122, -122, -123, -123, -123, -124, -124, -124, -124, -125, -125, -125, -125, -126, -126, -126, -126,
    -126, -127, -127, -127, -127, -127, -127, -127, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128,
    -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -127, -127, -127, -127, -127, -127, -127, -126, -126,
    -126, -126, -126, -125, -125, -125, -125, -124, -124, -124, -124, -123, -123, -123, -122, -122, -122, -121, -121,
    -121, -120, -120, -119, -119, -119, -118, -118, -117, -117, -116, -116, -116, -115, -115, -114, -114, -113, -112,
    -112, -111, -111, -110, -110, -109, -109, -108, -107, -107, -106, -105, -105, -104, -104, -103, -102, -102, -101,
    -100, -99,  -99,  -98,  -97,  -97,  -96,  -95,  -94,  -94,  -93,  -92,  -91,  -91,  -90,  -89,  -88,  -87,  -86,
    -86,  -85,  -84,  -83,  -82,  -81,  -81,  -80,  -79,  -78,  -77,  -76,  -75,  -74,  -73,  -72,  -72,  -71,  -70,
    -69,  -68,  -67,  -66,  -65,  -64,  -63,  -62,  -61,  -60,  -59,  -58,  -57,  -56,  -55,  -54,  -53,  -52,  -51,
    -50,  -49,  -48,  -47,  -46,  -45,  -44,  -43,  -42,  -41,  -40,  -38,  -37,  -36,  -35,  -34,  -33,  -32,  -31,
    -30,  -29,  -28,  -27,  -26,  -24,  -23,  -22,  -21,  -20,  -19,  -18,  -17,  -16,  -14,  -13,  -12,  -11,  -10,
    -9,   -8,   -7,   -6,   -4,   -3,   -2,   -1,   0,    1,    2,    3,    4,    6,    7,    8,    9,    10,   11,
    12,   13,   14,   16,   17,   18,   19,   20,   21,   22,   23,   24,   26,   27,   28,   29,   30,   31,   32,
    33,   34,   35,   36,   37,   38,   40,   41,   42,   43,   44,   45,   46,   47,   48,   49,   50,   51,   52,
    53,   54,   55,   56,   57,   58,   59,   60,   61,   62,   63,   64,   65,   66,   67,   68,   69,   70,   71,
    72,   72,   73,   74,   75,   76,   77,   78,   79,   80,   81,   81,   82,   83,   84,   85,   86,   86,   87,
    88,   89,   90,   91,   91,   92,   93,   94,   94,   95,   96,   97,   97,   98,   99,   99,   100,  101,  102,
    102,  103,  104,  104,  105,  105,  106,  107,  107,  108,  109,  109,  110,  110,  111,  111,  112,  112,  113,
    114,  114,  115,  115,  116,  116,  116,  117,  117,  118,  118,  119,  119,  119,  120,  120,  121,  121,  121,
    122,  122,  122,  123,  123,  123,  124,  124,  124,  124,  125,  125,  125,  125,  126,  126,  126,  126,  126,
    127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127};

char sin_table[720] = {
    0,    1,    2,    3,    4,    6,    7,    8,    9,    10,   11,   12,   13,   14,   16,   17,   18,   19,   20,
    21,   22,   23,   24,   26,   27,   28,   29,   30,   31,   32,   33,   34,   35,   36,   37,   38,   40,   41,
    42,   43,   44,   45,   46,   47,   48,   49,   50,   51,   52,   53,   54,   55,   56,   57,   58,   59,   60,
    61,   62,   63,   64,   65,   66,   67,   68,   69,   70,   71,   72,   72,   73,   74,   75,   76,   77,   78,
    79,   80,   81,   81,   82,   83,   84,   85,   86,   86,   87,   88,   89,   90,   91,   91,   92,   93,   94,
    94,   95,   96,   97,   97,   98,   99,   99,   100,  101,  102,  102,  103,  104,  104,  105,  105,  106,  107,
    107,  108,  109,  109,  110,  110,  111,  111,  112,  112,  113,  114,  114,  115,  115,  116,  116,  116,  117,
    117,  118,  118,  119,  119,  119,  120,  120,  121,  121,  121,  122,  122,  122,  123,  123,  123,  124,  124,
    124,  124,  125,  125,  125,  125,  126,  126,  126,  126,  126,  127,  127,  127,  127,  127,  127,  127,  127,
    127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,  127,
    127,  127,  127,  127,  127,  127,  127,  127,  126,  126,  126,  126,  126,  125,  125,  125,  125,  124,  124,
    124,  124,  123,  123,  123,  122,  122,  122,  121,  121,  121,  120,  120,  119,  119,  119,  118,  118,  117,
    117,  116,  116,  116,  115,  115,  114,  114,  113,  112,  112,  111,  111,  110,  110,  109,  109,  108,  107,
    107,  106,  105,  105,  104,  104,  103,  102,  102,  101,  100,  99,   99,   98,   97,   97,   96,   95,   94,
    94,   93,   92,   91,   91,   90,   89,   88,   87,   86,   86,   85,   84,   83,   82,   81,   81,   80,   79,
    78,   77,   76,   75,   74,   73,   72,   72,   71,   70,   69,   68,   67,   66,   65,   64,   63,   62,   61,
    60,   59,   58,   57,   56,   55,   54,   53,   52,   51,   50,   49,   48,   47,   46,   45,   44,   43,   42,
    41,   40,   38,   37,   36,   35,   34,   33,   32,   31,   30,   29,   28,   27,   26,   24,   23,   22,   21,
    20,   19,   18,   17,   16,   14,   13,   12,   11,   10,   9,    8,    7,    6,    4,    3,    2,    1,    0,
    -1,   -2,   -3,   -4,   -6,   -7,   -8,   -9,   -10,  -11,  -12,  -13,  -14,  -16,  -17,  -18,  -19,  -20,  -21,
    -22,  -23,  -24,  -26,  -27,  -28,  -29,  -30,  -31,  -32,  -33,  -34,  -35,  -36,  -37,  -38,  -40,  -41,  -42,
    -43,  -44,  -45,  -46,  -47,  -48,  -49,  -50,  -51,  -52,  -53,  -54,  -55,  -56,  -57,  -58,  -59,  -60,  -61,
    -62,  -63,  -64,  -65,  -66,  -67,  -68,  -69,  -70,  -71,  -72,  -72,  -73,  -74,  -75,  -76,  -77,  -78,  -79,
    -80,  -81,  -81,  -82,  -83,  -84,  -85,  -86,  -86,  -87,  -88,  -89,  -90,  -91,  -91,  -92,  -93,  -94,  -94,
    -95,  -96,  -97,  -97,  -98,  -99,  -99,  -100, -101, -102, -102, -103, -104, -104, -105, -105, -106, -107, -107,
    -108, -109, -109, -110, -110, -111, -111, -112, -112, -113, -114, -114, -115, -115, -116, -116, -116, -117, -117,
    -118, -118, -119, -119, -119, -120, -120, -121, -121, -121, -122, -122, -122, -123, -123, -123, -124, -124, -124,
    -124, -125, -125, -125, -125, -126, -126, -126, -126, -126, -127, -127, -127, -127, -127, -127, -127, -128, -128,
    -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128, -128,
    -127, -127, -127, -127, -127, -127, -127, -126, -126, -126, -126, -126, -125, -125, -125, -125, -124, -124, -124,
    -124, -123, -123, -123, -122, -122, -122, -121, -121, -121, -120, -120, -119, -119, -119, -118, -118, -117, -117,
    -116, -116, -116, -115, -115, -114, -114, -113, -112, -112, -111, -111, -110, -110, -109, -109, -108, -107, -107,
    -106, -105, -105, -104, -104, -103, -102, -102, -101, -100, -99,  -99,  -98,  -97,  -97,  -96,  -95,  -94,  -94,
    -93,  -92,  -91,  -91,  -90,  -89,  -88,  -87,  -86,  -86,  -85,  -84,  -83,  -82,  -81,  -81,  -80,  -79,  -78,
    -77,  -76,  -75,  -74,  -73,  -72,  -72,  -71,  -70,  -69,  -68,  -67,  -66,  -65,  -64,  -63,  -62,  -61,  -60,
    -59,  -58,  -57,  -56,  -55,  -54,  -53,  -52,  -51,  -50,  -49,  -48,  -47,  -46,  -45,  -44,  -43,  -42,  -41,
    -40,  -38,  -37,  -36,  -35,  -34,  -33,  -32,  -31,  -30,  -29,  -28,  -27,  -26,  -24,  -23,  -22,  -21,  -20,
    -19,  -18,  -17,  -16,  -14,  -13,  -12,  -11,  -10,  -9,   -8,   -7,   -6,   -4,   -3,   -2,   -1};

int Task_nrOFDMPhaseGeneration(short_struct subCarrierSpace, short_struct symbolNum, double_struct freq0) {

  //   double f0         = 2132.62e6;
  // input parameter
  uint16_t scs        = subCarrierSpace.data;
  uint8_t  symbol_num = symbolNum.data;
  double   f0         = freq0.data;

  int N_FFT     = 0;
  int cp_length = 0;

  if (scs == 15) {
    N_FFT = 2048;
    if (symbol_num == 0 || symbol_num == 7) {
      cp_length = 160;
    } else {
      cp_length = 144;
    }
  } else if (scs == 30) {
    N_FFT = 1024;
    // BUG
    // if (symbol_num == 0 || symbol_num == 7) {
    if (symbol_num == 0) {
      cp_length = 88;
    } else {
      cp_length = 72;
    }
  }

  if ((symbol_num <= 13) && (symbol_num >= 0)) {
    short n_mu_tot   = cp_length + N_FFT;
    short n_mu_start = 0;
    if (symbol_num == 0) {
      n_mu_start = 0 + cp_length;
    } else if (symbol_num > 0 && symbol_num < 7) {
      n_mu_start = symbol_num * N_FFT + (symbol_num + 1) * cp_length + 16;
    } else if (symbol_num == 7) {
      n_mu_start = symbol_num * N_FFT + (symbol_num + 1) * (cp_length - 16) + 32;
    } else {
      n_mu_start = symbol_num * N_FFT + (symbol_num + 1) * cp_length + 32;
    }

    double SR = N_FFT * scs;
    // double t_mu_start = n_mu_start / SR;
    double symbolPhases = -2 * f0 * n_mu_start / (SR * 1000);

    symbolPhases = symbolPhases - (int)(symbolPhases / (2)) * (2);
    if (symbolPhases < 0) {
      symbolPhases += 2;
    }
    //     symbolPhases = symbolPhases * PI;
    // int index = (int)(angle * TABLE_SIZE / (2 * PI));
    char cos_result = cos_table[(int)(symbolPhases * 720 / 2)];
    char sin_result = sin_table[(int)(symbolPhases * 720 / 2)];

    __v4096i8 Phase_cos;
    __v4096i8 Phase_sin;
    vclaim(Phase_cos);
    vclaim(Phase_sin);
    vbrdcst(Phase_cos, cos_result, MASKREAD_OFF, N_FFT);
    vbrdcst(Phase_sin, sin_result, MASKREAD_OFF, N_FFT);

    vreturn(Phase_cos, N_FFT, Phase_sin, N_FFT);
    // vreturn(Phase_cos, sizeof(Phase_cos), Phase_sin, sizeof(Phase_sin));
  } else {

    __v4096i8 Phase_cos;
    __v4096i8 Phase_sin;
    vclaim(Phase_cos);
    vclaim(Phase_sin);
    vbrdcst(Phase_cos, 0, MASKREAD_OFF, 1);
    vbrdcst(Phase_sin, 0, MASKREAD_OFF, 1);
    vreturn(Phase_cos, N_FFT, Phase_sin, N_FFT);
    // vreturn(Phase_cos, sizeof(Phase_cos), Phase_sin, sizeof(Phase_sin));
  }
}