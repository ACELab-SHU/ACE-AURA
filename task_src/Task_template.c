/**
 * ****************************************
 * @file        SSBurstFineFrequencyOffset.c
 * @brief       ssb fine frequency estimate using cp
 * @author      yuanfeng
 * @date        2024.4.24
 * @copyright   ACE-Lab(Shanghai University)
 * ****************************************
 */

#include <stdint.h>

#include "riscv_printf.h"
#include "venus.h"

typedef short __v4096i16 __attribute__((ext_vector_type(4096)));

// 定点化乘法
VENUS_INLINE __v4096i16 MUL4096_16_VV(__v4096i16 a, __v4096i16 b, int fractionLength, int vmr, int vectorLength)
{
    __v4096i16 high16;
    __v4096i16 low16;
    __v4096i16 result;
    if (vmr == MASKREAD_OFF)
    {
        low16 = vmul(a, b, MASKREAD_OFF, vectorLength);
        high16 = vmulh(a, b, MASKREAD_OFF, vectorLength);
        low16 = vsrl(low16, fractionLength, MASKREAD_OFF, vectorLength);
        high16 = vsll(high16, 16 - fractionLength, MASKREAD_OFF, vectorLength);
        result = vor(low16, high16, MASKREAD_OFF, vectorLength);
    }
    else
    {
        low16 = vmul(a, b, MASKREAD_ON, vectorLength);
        high16 = vmulh(a, b, MASKREAD_ON, vectorLength);
        low16 = vsrl(low16, fractionLength, MASKREAD_ON, vectorLength);
        high16 = vsll(high16, 16 - fractionLength, MASKREAD_ON, vectorLength);
        result = vor(low16, high16, MASKREAD_ON, vectorLength);
    }

    return result;
};

short input_waveform_real[1096] = {
    -302, 1146, 1340, -567, -1484, -220, 1285, 1142, 401, 664, 1400, 1066, 211, 247, 1104, 1291,
    580, 67, 6, -447, -1716, -2264, -1400, -763, -1509, -2317, -1367, 382, 529, -908, -1578, -400,
    562, -190, -1190, -354, 1417, 2075, 1330, 342, -114, -513, -1055, -1061, -755, -816, -920, -135,
    1246, 1674, 572, -392, 101, 743, 97, -1365, -1571, -174, 690, -122, -1125, -470, 1172, 1836,
    1160, 702, 1099, 966, -514, -1867, -1262, 290, 583, -310, -700, 88, 635, 61, -455, 128,
    1221, 1522, 923, -27, -1101, -1824, -1486, -54, 909, 398, -504, -569, -3, 434, 971, 1778,
    1778, 500, -806, -670, 514, 1241, 1196, 960, 322, -902, -1618, -923, 41, -135, -833, -315,
    1101, 1196, -428, -1811, -1641, -597, 126, 317, 278, -67, -285, 333, 1200, 1256, 688, 735,
    1356, 978, -344, -648, 561, 1235, -182, -1676, -985, 1254, 2214, 1035, -468, -759, -317, -280,
    -714, -684, 272, 1357, 1480, 725, 129, 100, -212, -1379, -2066, -1048, 728, 1179, 29, -762,
    -269, 44, -671, -1475, -962, 42, 8, -1008, -1451, -716, 355, 616, -170, -888, -377, 1287,
    2247, 1181, -801, -1379, -102, 1178, 1171, 644, 667, 1181, 1347, 1045, 424, -375, -958, -521,
    835, 1429, 369, -1181, -1698, -1110, -331, 348, 1051, 1245, 647, -86, 73, 1083, 1740, 1392,
    266, -926, -1603, -1489, -819, -400, -389, -152, 754, 1284, 513, -821, -881, 635, 2019, 1821,
    553, -440, -727, -1072, -1691, -1659, -551, 519, 233, -931, -1036, 475, 1468, 380, -1473, -1629,
    -146, 596, -214, -1037, -563, 172, 31, -218, 351, 1191, 1306, 921, 701, -14, -1366, -2049,
    -789, 1085, 1169, -409, -1057, 183, 1288, 845, -15, 436, 1462, 1382, 490, 443, 1349, 1581,
    813, 33, 270, 10, -2614, -395, 18, -809, 129, -1012, 2059, -439, -305, 235, -696, 1604,
    1319, -1472, -2444, 2184, -1698, -1753, 871, -466, 1099, 1600, -109, -283, -1392, -2960, 493, 649,
    -398, -27, 322, 1285, 884, -75, 841, 580, -176, -325, 326, 562, 1100, 512, -224, -338,
    -239, 127, -1145, -559, -210, -163, -501, 251, -448, 40, 2323, 25, -467, 1070, -351, 1017,
    190, -1143, 1351, -351, 647, -689, -586, -258, -1146, -113, -1052, 302, 132, 579, -526, 714,
    245, -1249, 806, -928, 111, -448, -927, 1737, -1628, -192, 701, -1170, 372, -130, 1563, 537,
    698, 386, -950, 659, -53, -476, 584, 752, 417, 792, 273, 674, 132, 188, -1213, -944,
    94, -471, 491, -218, 2829, 1956, 771, -538, -1298, 1138, -488, 1238, -221, -664, 891, -1594,
    -1803, 106, 884, 717, 2237, 2515, 1718, 1276, 1081, 874, -772, 55, 1549, 153, 155, -1209,
    445, 937, -356, 1326, 600, 144, -621, 200, 403, -165, 181, 1563, 861, -416, -1131, 162,
    948, -238, 1545, 112, -396, 582, 1354, -615, -1313, -326, -1061, -539, 451, -692, -1207, 696,
    -1106, -721, -934, -58, 1952, 1084, 1153, 340, 488, 1569, -348, -1972, -278, 1089, -82, -1296,
    177, -217, -714, -855, 345, -547, -2287, -240, -830, -767, -859, -532, 238, -1555, -419, -14,
    -460, 247, -901, -108, -427, -1159, 602, 2138, 2399, 491, 70, -303, -903, 1032, 899, -679,
    265, 541, 844, 1356, 16, 2014, 411, -2364, -701, -1260, -223, 18, -458, -518, 210, -403,
    -1084, 319, -367, 1776, 959, -1587, -95, 69, 793, 1803, 692, -263, -862, -952, -233, 514,
    -369, -318, 97, -436, -1309, -317, -135, -152, 343, -875, 1260, -293, -30, 304, -184, 604,
    1058, -728, -1618, 1245, -555, 83, -522, 84, 781, 246, -135, -704, 249, -520, -2957, -969,
    1346, 651, 225, -1092, 149, 767, 955, -1138, -2516, 849, -854, -27, -102, 1238, 2047, -710,
    2059, 668, 1068, 1267, 2, 1015, 591, 6, -727, 583, 1107, 1358, -455, -69, 330, -902,
    -205, -675, -174, -897, 1123, -396, -7, 618, -1794, 351, -1482, 1197, 299, 501, 1640, -2566,
    -1167, -329, 259, -402, -791, -1012, -526, 94, 1001, 420, 45, 1219, -1212, -446, -161, -1152,
    -815, -216, 980, 822, 611, -694, -1189, 1216, 916, -356, 318, -874, -917, 545, 152, -844,
    -922, 507, -39, 453, 1787, 260, -100, 454, 240, -428, 486, 303, -44, 722, -40, -1304,
    77, -207, -1403, 739, -1518, -1938, 480, -1186, -1301, 433, -43, -200, -46, 911, 668, 158,
    1440, -326, -225, -162, -753, 344, -321, 404, 144, -1789, -1465, 382, 246, -55, 613, -1016,
    -42, 920, 1505, 447, -432, -1142, -1568, 486, -475, 1411, -523, -1158, 344, -723, -1053, -925,
    58, 923, 746, 1, 839, -300, 732, -208, -364, 260, 901, 908, -403, 266, 112, 816,
    432, 401, 582, 457, 666, 1210, 1233, 1087, 444, 810, -1714, -531, 515, -277, 1455, -979,
    473, -119, 425, 1127, -709, 118, -608, 108, 379, -389, 820, 425, 951, 86, 120, -571,
    345, 2145, -1018, 1679, -558, 1069, 452, -2253, 1046, -251, 562, 57, -1404, -1247, 1202, 571,
    104, 240, 566, -359, 43, 721, -632, 1247, 571, -124, -638, -908, -974, -939, 27, 611,
    1121, 1658, 547, 221, -686, -1207, -110, -304, -452, -140, -521, -1048, 382, -174, 385, 307,
    828, 291, -115, 676, -633, 12, -333, 539, 720, 668, 190, -299, 419, -489, -2338, -749,
    1046, 905, 279, -1692, -187, 884, -571, -795, 539, -665, 575, -410, -1037, 791, 1500, 194,
    -362, -388, -457, 628, 238, -52, -192, 645, 1022, -1268, 915, -677, -767, 1711, -892, 186,
    -220, 304, 849, 1203, 1730, 83, -1327, -716, -25, 169, 1097, -408, 729, 454, -246, 1214,
    -28, -214, -530, -1159, -193, -1092, -431, -440, -487, 55, -302, 314, 56, 757, 97, 606,
    208, 606, 1543, -466, 214, 993, 384, 1087, 470, -1313, -522, -1958, -362, 1567, 1079, 1834,
    -1002, -1208, 837, 259, -1473, 166, 675, -1022, 75, 710, -720, -1289, 1451, -118, -1143, 568,
    -86, 227, 582, 232, 685, 1117, -819, -17, 818, -321, 71, -822, -490, 292, 81, 1492,
    -136, -348, 1046, -442, 547, -505, -1789, 122, 918, -1101, -940, 2612, 744, -1065, -140, -1365,
    1360, 1740, 1873, 975, -1713, 854, -1822, -2306, -1298, -1399, -688, -466, 955, -162, 201, 565,
    -141, -791, -421, -150, -556, -838, -231, 523, 204, 136, -936, -577, 405, -722, 103, -1132,
    -883, 1137, -813, -545, -1455, -828, -948, -1396, 696, 845, -667, -1908, -117, -481, 340, 642,
    -378, -135, -195, -693, -454, 1550, 524, 1022, 58, 308, 650, -1452, 550, 81, 739, -111,
    -609, -253, -28, -1514, -1601, 1670, -1053, 1135, 572, 145, 1824, -644, -724, -626, -786, -1107,
    504, 383, -838, -1232, -787, 435, -585, -822, 379, -733, -1278, -265, 1014, 103, 1143, 962,
    -515, -348, 341, 1951, 231, -467, -1422, 378, 369, -548, -1322, 94, 339, -2297, -544, -1702,
    -713, -118, 241, 584, -761, -1321, 539, 775, 220, -206, -485, 448, -1298, -414, -690, 385,
    1918, -110, 67, 222, -1118, 582, -291, -391, 691, -693, 470, -99, -1120, 426, 1853, 361,
    -206, -481, -729, 226, 243, -28, -274, 1053};
short input_waveform_imag[1096] = {
    284, 106, -60, -216, -887, -1464, -855, 676, 1481, 507, -1264, -1875, -1286, -867, -1311, -1749,
    -1113, -148, 157, -213, -496, -306, -274, -589, -822, -492, 243, 1019, 1424, 933, -355, -1512,
    -1314, -10, 990, 557, -354, -316, 597, 1305, 1352, 1248, 933, 66, -1133, -1625, -1118, -239,
    500, 1124, 1320, 433, -1222, -2123, -1474, -305, -4, -551, -1132, -1249, -909, -252, 86, -272,
    -882, -560, 570, 1302, 1123, 960, 1118, 487, -992, -1315, 617, 2544, 1892, -372, -1430, -603,
    50, -486, -1100, -964, -459, 75, 740, 1278, 1314, 926, 1023, 1524, 1555, 1060, 662, 391,
    -175, -392, 418, 1523, 1476, 528, 470, 1431, 1754, 762, -58, 454, 1255, 1292, 1127, 1167,
    570, -629, -1002, 328, 1359, 290, -1247, -902, 849, 1240, -375, -1589, -702, 1025, 1628, 929,
    -55, -729, -1204, -1060, -57, 948, 784, -463, -1344, -945, -10, 17, -822, -1089, 85, 1589,
    1896, 972, 336, 814, 1490, 908, -583, -1357, -440, 796, 612, -895, -1665, -531, 1112, 1080,
    -392, -1384, -896, 91, 733, 1392, 1809, 961, -758, -1179, 146, 1233, 338, -1016, -721, 416,
    226, -865, -837, 371, 1067, 755, 716, 1237, 841, -462, -638, 820, 1848, 1390, 835, 1193,
    1518, 719, -184, 79, 823, 1060, 971, 1186, 1296, 873, 670, 1202, 1506, 781, -383, -823,
    -880, -867, -363, 493, 329, -931, -1350, 469, 2375, 1713, -539, -1290, -203, 625, 259, 134,
    1104, 1519, 513, -407, -41, 670, 251, -853, -1345, -1027, -650, -591, -746, -1018, -1421, -1488,
    -651, 708, 1635, 1553, 512, -743, -1628, -1726, -1027, -118, 608, 967, 1235, 1235, 911, 473,
    246, 305, 257, -301, -1121, -1263, -446, 831, 1369, 544, -790, -1405, -1032, -725, -841, -1247,
    -752, -330, 813, 2220, -1888, 281, 906, -2136, -1424, 1352, 278, -2, -854, -1025, -1285, 1932,
    -1049, -1679, 875, -409, 3172, -1399, 58, 182, 63, -2664, 180, 524, -1502, 354, -3205, 458,
    -957, 1717, 356, -5, 1778, 147, 449, -116, -54, -397, 568, -836, 191, 763, 653, -530,
    -735, 1253, 741, -319, -996, -256, 478, -532, 3, 165, -64, -188, -798, 1788, 308, -1617,
    -330, -48, -1181, -42, -35, 396, -273, -1065, 597, 133, 240, -56, 747, -931, -943, 83,
    1074, -359, -1872, -101, 27, -26, 1321, -273, -2090, 1143, -437, -539, 369, 126, 29, -664,
    -60, 136, -167, 481, 990, -215, -1097, 236, 2288, -84, 482, 1061, -247, 272, 866, 465,
    -146, -475, -907, 51, 1200, 216, -360, -228, -140, 1874, 625, -365, -1086, -994, -316, -629,
    -1233, -1294, 422, 1333, 90, -683, -391, -1469, 7, 826, 1137, 269, -884, 848, 1621, -1003,
    -1363, -259, -886, 1300, 1206, -428, 269, 191, -853, -233, 1041, 1076, -584, 48, 554, 286,
    153, 1060, 652, -362, 1298, 797, 849, -333, -1180, -1093, -577, -1043, 126, 163, -68, 1058,
    5, 1134, -1313, 325, -32, -2190, 336, -466, 286, 755, -1337, -2226, 410, 554, -1036, 294,
    -66, -724, -135, -545, -1430, -24, 1214, -81, 382, 575, -430, -1516, 656, 1280, -561, 443,
    -1918, -134, 978, -786, 1356, 567, 71, -317, -103, 578, 96, -467, 68, 512, -311, 611,
    -603, -933, 609, -149, -831, 424, 43, -684, -1018, 496, 967, -772, 1158, -810, -240, -300,
    31, 1688, -966, -52, 105, 1066, 636, -775, -1742, 612, 225, -523, 1288, -415, 1041, -662,
    -496, -1030, 60, 1540, -1688, 188, 552, -1441, -882, 716, 523, -72, -576, -590, -918, 1516,
    -474, -1204, 86, 247, 920, 137, -501, -1593, 165, -1438, -1104, -1327, -580, 2, -1723, -505,
    788, -745, -450, 2536, 428, 603, -602, -1047, 709, 1479, -574, -1603, -200, 1691, 1588, -366,
    685, -858, 399, -955, -868, 115, -170, 904, -753, 388, -223, -909, -150, -372, -598, 247,
    448, 78, 875, 582, -633, 859, 832, -160, 1589, -868, -1356, -934, -1056, -712, 618, 1339,
    -98, 1783, -6, -108, -900, -578, 194, -673, 451, -428, 38, -537, -170, -888, -74, 622,
    1729, -165, -1680, 1192, -151, 578, 204, -863, -610, 126, -853, -1145, -179, 223, 234, -575,
    -955, -568, 98, -513, 235, -233, 709, 172, -552, 139, -1025, -222, 796, -111, -1392, 384,
    67, 345, 1376, -801, -778, -954, -1693, -302, -721, -1239, 589, -678, -1199, 38, -163, 8,
    -651, 19, -926, -832, 1369, -243, -832, -170, 242, -558, -1320, -120, 635, 207, 1087, 1212,
    -870, 999, 677, -1466, -205, 916, 1408, 693, 68, -411, -1807, -769, 1370, -578, 403, -195,
    -936, 1253, 784, 1520, -405, -248, 224, -245, 921, 209, -328, 391, -1001, -1156, 144, -824,
    -94, 325, 22, -90, 1406, 350, 797, 1222, 687, 832, -362, 817, 479, 554, -347, 113,
    -572, -481, 533, -387, -135, -252, 296, -1301, -1092, 85, -782, 291, 1343, 1, -394, 500,
    392, 508, 563, -862, -738, -381, 978, 502, -1025, -710, -943, 1055, 491, 737, 1024, -494,
    1145, -498, -1464, 650, -1240, 0, 945, 1073, 552, -15, 117, 55, 2616, -9, -426, -742,
    -992, 314, 917, -23, 814, 862, -1742, 746, 249, -780, 1112, 874, -447, 1063, -597, 486,
    -59, -2001, -156, -333, 136, 347, -708, -1447, 347, -1257, -1073, -1438, -477, -160, -2435, -740,
    1104, -515, -363, 2154, 427, 825, -686, -1444, -502, 174, 424, -1104, 477, 1232, -1292, -618,
    -435, 422, 947, 1204, -133, 7, 21, -1073, 188, 1439, -33, -2221, 831, -471, 287, -1360,
    -1195, 666, -1075, 343, 1049, 269, -1073, 797, 256, -781, -912, 117, -239, 161, -896, -713,
    435, -1322, 483, 905, 1392, 662, 154, 1039, 772, 1024, 1326, 356, 372, 477, -803, 526,
    607, -304, 1265, -868, 523, 1232, -745, -850, -1064, 366, -1301, 1051, 924, 179, -167, -243,
    936, 833, -243, -1397, 336, 99, 554, -1307, -633, -943, 253, 189, 206, 409, -362, 2143,
    362, 459, -962, 34, -106, 156, 517, 246, 430, 399, 2185, -865, -170, 779, -23, -637,
    542, 644, -768, 251, 485, -357, 513, 124, -1277, 719, -825, 34, -505, -683, 1033, 657,
    236, -2659, 448, 781, 91, 319, -847, 256, -157, -879, -983, 1412, 1386, 576, 489, -6,
    537, -216, -1612, -236, -84, -301, -389, 751, 1814, -689, 86, -2083, -753, 1692, -56, -521,
    -975, -70, -99, 568, 797, -37, 359, 460, -755, -33, 135, 415, -1062, -706, 812, -1099,
    754, -357, -1235, 1008, -95, -1209, 543, 358, -1282, -470, 1352, 1742, 2012, 1544, 756, 970,
    192, 2464, 291, -579, 1030, -112, 485, 7, 1819, -585, -980, 1475, 707, 1373, 598, 1465,
    363, -1599, -39, 174, -475, -265, 219, -1107, 350, 1621, -1080, 450, -328, -1010, 265, -858,
    -294, 1699, 1229, -404, 1167, -765, -687, -167, 344, 707, -2171, -586, 946, -167, -1030, -644,
    -841, 428, 998, 915, 30, -677, -226, 129, 62, -699, -818, 598, 664, 9, 763, -1347,
    660, 1079, 818, 844, -139, 1241, -1072, -1510, -417, -2, 546, -1159, 144, 1382, -823, -531,
    -497, 303, 762, 1295, -52, 1, -28, -828};

/* Cordic parameter */
#define DEPTH 16              // 最大赋值为16
#define DEP_SHIFT (DEPTH - 1) // tan数组中的标幺值移位

// #define DIVPI 57.295779513082    //即弧度转角度,180/pi
#define DIVPI 57.295779513082 // 即弧度转角度,180/pi
#define ANG_PRECICE 12        // 缩放倍数，决定了精度

unsigned short _tan[16] = {32768, 16384, 8192, 4096, 2048, 1024, 512, 256, 128, 64, 32, 16, 8, 4, 2, 1};
unsigned int _angle[16] = {184319, 108810, 57492, 29184, 14648, 7331, 3666, 1833, 916, 458, 229, 114, 57, 28, 14, 7};

unsigned short scs = 15000;

int main()
{
    int waveLength = 1096;

    /* 小数倍频偏估计 */
    __v4096i16 waveform_real;
    __v4096i16 waveform_imag;
    vclaim(waveform_real);
    VSPM_OPEN();
    vbarrier();
    int waveform_real_addr = vaddr(waveform_real);
    for (int i = 0; i < waveLength; ++i)
    {
        *(volatile unsigned short *)(waveform_real_addr + (i << 1)) = input_waveform_real[i];
    }
    VSPM_CLOSE();

    vclaim(waveform_imag);
    VSPM_OPEN();
    vbarrier();
    int waveform_imag_addr = vaddr(waveform_imag);
    for (int i = 0; i < waveLength; ++i)
    {
        *(volatile unsigned short *)(waveform_imag_addr + (i << 1)) = input_waveform_imag[i];
    }
    VSPM_CLOSE();

    int fractionLength = 12;

    // Get 'Lsym', the number of time domain samples in an OFDM symbol,
    // which is the sum of 'Lcp' and 'Lu', the number of cyclic prefix
    // samples and useful samples respectively
    int Lcp = 18;
    int Lu = 256;
    int Lsym = Lcp + Lu;
    __v4096i16 Lu_vec;
    vclaim(Lu_vec);
    vbrdcst(Lu_vec, Lu, MASKREAD_OFF, waveLength);

    // Multiply the waveform by itself delayed by Lu samples and conjugated
    __v4096i16 delayed_shuffle_index;
    vclaim(delayed_shuffle_index);
    vrange(delayed_shuffle_index, waveLength);
    delayed_shuffle_index = vsub(Lu_vec, delayed_shuffle_index, MASKREAD_OFF, waveLength);

    vsgt(delayed_shuffle_index, 0, MASKREAD_OFF, MASKWRITE_ON,
         waveLength); // trick hack code TODO: change to vslt

    __v4096i16 zero_vec;
    vclaim(zero_vec);
    vbrdcst(zero_vec, 0, MASKREAD_OFF, waveLength);
    delayed_shuffle_index = vmul(zero_vec, delayed_shuffle_index, MASKREAD_ON, waveLength);
    //   VENUS_PRINTVEC_SHORT(delayed_shuffle_index, 258);
    __v4096i16 delayed_real;
    __v4096i16 delayed_imag;
    vclaim(delayed_real);
    vclaim(delayed_imag);
    vshuffle(delayed_real, delayed_shuffle_index, waveform_real, SHUFFLE_GATHER, waveLength);
    vshuffle(delayed_imag, delayed_shuffle_index, waveform_imag, SHUFFLE_GATHER, waveLength);
    delayed_imag = vmul(delayed_imag, -1, MASKREAD_OFF, waveLength);

    // 4个symbol的cp互相关
    __v4096i16 cpProduct_real;
    __v4096i16 cpProduct_imag;
    __v4096i16 cpProduct_tmpReal1;
    __v4096i16 cpProduct_tmpReal2;
    __v4096i16 cpProduct_tmpImag1;
    __v4096i16 cpProduct_tmpImag2;
    vsetshamt(fractionLength);
    cpProduct_tmpReal1 = vmul(waveform_real, delayed_real, MASKREAD_OFF, waveLength);
    cpProduct_tmpReal2 = vmul(waveform_imag, delayed_imag, MASKREAD_OFF, waveLength);
    // cpProduct_tmpReal1 = MUL4096_16_VV(waveform_real, delayed_real,
    //                                    fractionLength, MASKREAD_OFF,
    //                                    waveLength);
    // cpProduct_tmpReal2 = MUL4096_16_VV(waveform_imag, delayed_imag,
    //                                    fractionLength, MASKREAD_OFF,
    //                                    waveLength);
    vsetshamt(0);
    // VENUS_PRINTVEC_SHORT(cpProduct_tmpReal1, 257);
    cpProduct_real = vsub(cpProduct_tmpReal2, cpProduct_tmpReal1, MASKREAD_OFF, waveLength);
    vsetshamt(fractionLength);
    cpProduct_tmpImag1 = vmul(waveform_real, delayed_imag, MASKREAD_OFF, waveLength);
    cpProduct_tmpImag2 = vmul(waveform_imag, delayed_real, MASKREAD_OFF, waveLength);
    // cpProduct_tmpImag1 = MUL4096_16_VV(waveform_real, delayed_imag,
    //                                    fractionLength, MASKREAD_OFF,
    //                                    waveLength);
    // cpProduct_tmpImag2 = MUL4096_16_VV(waveform_imag, delayed_real,
    //                                    fractionLength, MASKREAD_OFF,
    //                                    waveLength);
    vsetshamt(0);
    cpProduct_imag = vadd(cpProduct_tmpImag2, cpProduct_tmpImag1, MASKREAD_OFF, waveLength);

    //   VENUS_PRINTVEC_SHORT(cpProduct_real, 258);
    short cpCorrResult_real = 0;
    short cpCorrResult_imag = 0;
    // Moving sum over 4 OFDM symbols (i.e. the size of the SS block)
    int cpProduct_real_addr = vaddr(cpProduct_real);
    VSPM_OPEN();
    for (int i = 1; i <= 4; ++i)
    {
        for (int j = -Lcp; j < 0; ++j)
        {
            cpCorrResult_real += *(volatile unsigned short *)(cpProduct_real_addr + ((Lsym * i + j) << 1));
        }
    }
    VSPM_CLOSE();
    int cpProduct_imag_addr = vaddr(cpProduct_imag);
    for (int i = 1; i <= 4; ++i)
    {
        for (int j = -Lcp; j < 0; ++j)
        {
            cpCorrResult_imag += *(volatile unsigned short *)(cpProduct_imag_addr + ((Lsym * i + j) << 1));
        }
    }
    printf("cpCorrResult_real:%hd\n", &cpCorrResult_real);
    printf("cpCorrResult_imag:%hd\n", &cpCorrResult_imag);

    // TODO: angle
    int16_t x = cpCorrResult_real, y = cpCorrResult_imag;
    int flag = 0;
    if (x < 0)
    {
        x = -x;
        flag |= 1 << 0;
    }
    if (y < 0)
    {
        y = -y;
        flag |= 1 << 1;
    }
    if (y > x)
    {
        int tmp = y;
        y = x;
        x = tmp;
        flag |= 1 << 2;
    }
    int x_tan, y_tan, _y, _x;
    uint16_t *ptan = (uint16_t *)&_tan; // 指针访问比数组访问快
    uint32_t *pang = (uint32_t *)&_angle;
    uint32_t res = 0;

    /* 限制范围在uint16范围内,后续乘法不会超过uint32范围,防止溢出 */
    _y = ((y << DEPTH) - 1) / x; // 前面保证x>y,所以这里_y<65535
    _x = (1 << DEPTH) - 1;       // 即为1/* 迭代计算 */

    for (int i = 0; i < DEPTH; i++)
    {
        // 由于x_tan和y_tan有正有负,设置为int类型,但最大值为31位,故前面的tan用Q15来表示
        x_tan = (_x * (*ptan)) >> DEP_SHIFT; // Q15的tan * Q16的用户输入,计算后要右移Q15
        y_tan = (_y * (*ptan++)) >> DEP_SHIFT;
        if (_y > 0)
        {
            _x += y_tan;
            _y -= x_tan;
            res += *pang++;
        }
        else
        {
            _x -= y_tan;
            _y += x_tan;
            res -= *pang++;
        }
    }
    if (flag & 0x04)
    {
        switch (flag)
        {
        case 7:
            res = (270 << ANG_PRECICE) - res;
            break;
        case 4:
            res = (90 << ANG_PRECICE) - res;
            break;
        case 5:
            res = (90 << ANG_PRECICE) + res;
            break;
        case 6:
            res = (270 << ANG_PRECICE) + res;
            break;
        }
    }
    else
    {
        switch (flag)
        {
        case 0:
            break;
        case 1:
            res = (180 << ANG_PRECICE) - res;
            break;
        case 2:
            res = (360 << ANG_PRECICE) - res;
            break;
        case 3:
            res = (180 << ANG_PRECICE) + res;
            break;
        }
    }
    short result = (double)res * scs / 360 / (1 << ANG_PRECICE);
    //   printf("res:%hd\n", &result);
    return 0;
}